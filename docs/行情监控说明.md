# HTX 行情监控说明

## 功能介绍

独立的行情趋势监控程序，监控指定合约的价格趋势变化，并在关键时刻发送 Telegram 通知。

**与持仓监控的区别：**
- `realtime-pnl.js` - 监控你的持仓盈亏
- `market-monitor.js` - 监控市场行情趋势（不需要有持仓）

## 快速开始

### 1. 配置监控合约

编辑 `market-config.js`：

```javascript
export const marketConfig = {
  // 要监控的合约列表
  watchContracts: [
    'BTC-USDT',
    'ETH-USDT',
    'SOL-USDT',
    // 添加更多合约
  ],

  // 趋势判断配置
  trendConfig: {
    priceHistorySize: 10,      // 保留最近 10 个价格点
    trendThreshold: 0.7,       // 70% 同向即判定为趋势
    minPricePoints: 5,         // 至少需要 5 个价格点才判断趋势
  },

  // 通知配置
  notifyConfig: {
    trendChangePercent: 1.0,   // 趋势持续变化 1% 时通知
    repeatInterval: 5 * 1000,  // 5 秒防重复
  },
};
```

### 2. 运行监控

```bash
node market-monitor.js
```

---

## 通知场景

### 1. 趋势开始

**上涨趋势开始：**
```
📈 行情提醒

🟢 BTC-USDT

📊 价格信息
当前价格: 105000.00 USDT
价格变化: +500.00 USDT
变化幅度: +0.48%

🎯 趋势分析
当前趋势: 上涨 📈
触发原因: 开始上涨趋势
```

**下跌趋势开始：**
```
📉 行情提醒

🔴 ETH-USDT

📊 价格信息
当前价格: 2250.00 USDT
价格变化: -30.00 USDT
变化幅度: -1.32%

🎯 趋势分析
当前趋势: 下跌 📉
触发原因: 开始下跌趋势
```

### 2. 趋势持续

**持续上涨（每上涨 1% 通知）：**
```
触发原因: 持续上涨 +1.05%
```

**持续下跌（每下跌 1% 通知）：**
```
触发原因: 持续下跌 -1.12%
```

### 3. 趋势反转

```
触发原因: 趋势反转：转为上涨
```

### 4. 趋势结束

```
触发原因: 趋势结束，进入震荡
```

---

## 配置说明

### 监控合约

```javascript
watchContracts: [
  'BTC-USDT',
  'ETH-USDT',
  'SOL-USDT',
  'DOGE-USDT',
  'XRP-USDT',
]
```

可以添加任意 HTX 支持的永续合约。

### 趋势判断

**priceHistorySize: 10**
- 保留最近 10 个价格点
- 价格点越多，趋势判断越稳定，但反应越慢
- 建议：5-15

**trendThreshold: 0.7**
- 70% 的价格点同向变化即判定为趋势
- 值越大，趋势判断越严格
- 建议：0.6-0.8

**minPricePoints: 5**
- 至少需要 5 个价格点才开始判断趋势
- 避免数据不足时误判
- 建议：3-7

### 通知配置

**trendChangePercent: 1.0**
- 趋势持续变化 1% 时通知
- 值越小，通知越频繁
- 建议：0.5-2.0

**repeatInterval: 5 * 1000**
- 5 秒内不重复通知
- 防止短时间内重复触发
- 建议：3-10 秒

---

## 趋势判断逻辑

### 上涨趋势

最近 10 个价格点中，如果 7 个（70%）都比前一个高，判定为上涨趋势。

**示例：**
```
价格序列: 100 → 101 → 102 → 101 → 103 → 104 → 105 → 106 → 107 → 108
变化方向: ↑   ↑   ↓   ↑   ↑   ↑   ↑   ↑   ↑
上涨次数: 8/9 = 89% > 70% → 判定为上涨趋势
```

### 下跌趋势

最近 10 个价格点中，如果 7 个（70%）都比前一个低，判定为下跌趋势。

### 震荡（中性）

既不满足上涨条件，也不满足下跌条件，判定为震荡。

---

## 使用场景

### 场景 1：短线交易

```javascript
trendConfig: {
  priceHistorySize: 5,       // 快速反应
  trendThreshold: 0.6,       // 宽松判断
  minPricePoints: 3,
},
notifyConfig: {
  trendChangePercent: 0.5,   // 频繁通知
  repeatInterval: 3 * 1000,
},
```

### 场景 2：中长线观察

```javascript
trendConfig: {
  priceHistorySize: 15,      // 稳定判断
  trendThreshold: 0.8,       // 严格判断
  minPricePoints: 7,
},
notifyConfig: {
  trendChangePercent: 2.0,   // 减少通知
  repeatInterval: 10 * 1000,
},
```

### 场景 3：多币种监控

```javascript
watchContracts: [
  'BTC-USDT',
  'ETH-USDT',
  'SOL-USDT',
  'DOGE-USDT',
  'XRP-USDT',
  'ADA-USDT',
  'AVAX-USDT',
  'MATIC-USDT',
],
```

---

## 后台运行

### 使用 pm2

```bash
# 启动
pm2 start market-monitor.js --name market-monitor

# 查看日志
pm2 logs market-monitor

# 停止
pm2 stop market-monitor

# 重启
pm2 restart market-monitor
```

### 同时运行两个监控

```bash
# 持仓监控
pm2 start realtime-pnl.js --name pnl-monitor

# 行情监控
pm2 start market-monitor.js --name market-monitor

# 查看所有
pm2 list
```

---

## 注意事项

1. **网络稳定性** - 需要稳定的网络连接
2. **Telegram 配置** - 需要配置 TELEGRAM_BOT_TOKEN 和 TELEGRAM_CHAT_ID
3. **通知频率** - 根据需要调整配置，避免过于频繁
4. **监控合约数量** - 建议不超过 10 个，避免消息过多

---

## 故障排查

### 问题 1：没有收到通知

**检查：**
- Telegram 配置是否正确
- 网络是否正常
- 是否有明显的趋势变化

### 问题 2：通知太频繁

**解决：**
- 增大 `trendChangePercent`
- 增大 `repeatInterval`
- 提高 `trendThreshold`

### 问题 3：趋势判断不准

**调整：**
- 增加 `priceHistorySize`（更稳定）
- 提高 `trendThreshold`（更严格）
- 增加 `minPricePoints`（更可靠）

---

## 总结

✅ **独立监控** - 不需要持仓，监控市场趋势  
✅ **智能判断** - 基于价格序列判断趋势  
✅ **及时通知** - 趋势开始/持续/反转/结束  
✅ **灵活配置** - 可自定义监控合约和参数  

祝交易顺利！📈
