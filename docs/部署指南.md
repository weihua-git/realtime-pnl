# 部署指南

## 快速部署

### 1. 安装依赖

```bash
npm install
```

### 2. 配置环境变量

```bash
# 复制配置模板
cp config.example.env .env

# 编辑 .env 文件，填入你的配置
# 必需：HTX_ACCESS_KEY, HTX_SECRET_KEY
# 可选：BARK_KEY（推荐）或 TELEGRAM_BOT_TOKEN + TELEGRAM_CHAT_ID
```

### 3. 检查配置

```bash
npm run build
```

这会检查：
- ✅ 配置文件是否完整
- ✅ 依赖是否安装
- ✅ 关键文件是否存在

### 4. 测试通知（可选）

```bash
# 测试 Bark 通知
npm run test:bark

# 测试 Telegram 通知
npm run test:telegram

# 测试所有通知
npm run test
```

### 5. 启动监控

```bash
npm start
```

---

## 可用命令

### 运行命令

```bash
npm start              # 启动监控（生产模式）
npm run dev            # 启动监控（开发模式，自动重启）
npm run old            # 启动旧版基础监听
```

### 测试命令

```bash
npm run test           # 测试所有通知
npm run test:bark      # 测试 Bark 通知
npm run test:telegram  # 测试 Telegram 通知
npm run test:unified   # 测试统一通知器
npm run test:sound     # 测试音效配置
npm run test:quick     # 快速配置测试
```

### 构建命令

```bash
npm run build          # 完整构建检查
npm run check          # 检查配置
npm run clean          # 清理临时文件
```

### 依赖管理

```bash
npm run install:deps   # 安装依赖
npm run update:deps    # 更新依赖
```

---

## 生产环境部署

### 使用 PM2（推荐）

PM2 是一个生产级的 Node.js 进程管理器。

#### 1. 安装 PM2

```bash
npm install -g pm2
```

#### 2. 启动应用

```bash
pm2 start realtime-pnl.js --name htx-monitor
```

#### 3. 常用命令

```bash
pm2 list              # 查看所有进程
pm2 logs htx-monitor  # 查看日志
pm2 restart htx-monitor  # 重启
pm2 stop htx-monitor  # 停止
pm2 delete htx-monitor   # 删除
```

#### 4. 开机自启

```bash
pm2 startup           # 生成启动脚本
pm2 save              # 保存当前进程列表
```

#### 5. 监控

```bash
pm2 monit             # 实时监控
```

### 使用 systemd（Linux）

#### 1. 创建服务文件

```bash
sudo nano /etc/systemd/system/htx-monitor.service
```

#### 2. 添加以下内容

```ini
[Unit]
Description=HTX Futures Monitor
After=network.target

[Service]
Type=simple
User=your_username
WorkingDirectory=/path/to/htx-monitor
ExecStart=/usr/bin/node realtime-pnl.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

#### 3. 启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl start htx-monitor
sudo systemctl enable htx-monitor  # 开机自启
```

#### 4. 管理服务

```bash
sudo systemctl status htx-monitor   # 查看状态
sudo systemctl restart htx-monitor  # 重启
sudo systemctl stop htx-monitor     # 停止
sudo journalctl -u htx-monitor -f   # 查看日志
```

### 使用 Docker

#### 1. 创建 Dockerfile

```dockerfile
FROM node:16-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install --production

COPY . .

CMD ["node", "realtime-pnl.js"]
```

#### 2. 创建 .dockerignore

```
node_modules
.env
.git
*.md
test-*.js
```

#### 3. 构建镜像

```bash
docker build -t htx-monitor .
```

#### 4. 运行容器

```bash
docker run -d \
  --name htx-monitor \
  --restart unless-stopped \
  --env-file .env \
  htx-monitor
```

#### 5. 管理容器

```bash
docker logs -f htx-monitor      # 查看日志
docker restart htx-monitor      # 重启
docker stop htx-monitor         # 停止
docker rm htx-monitor           # 删除
```

---

## 服务器部署建议

### 1. 系统要求

- **操作系统**: Linux (Ubuntu 20.04+) / macOS / Windows
- **Node.js**: v16.0.0 或更高
- **内存**: 最低 512MB，推荐 1GB+
- **网络**: 稳定的互联网连接

### 2. 安全建议

#### 保护 API 密钥

```bash
# 设置 .env 文件权限
chmod 600 .env

# 确保不提交到 Git
echo ".env" >> .gitignore
```

#### 使用环境变量（推荐）

```bash
# 不使用 .env 文件，直接设置环境变量
export HTX_ACCESS_KEY="your_key"
export HTX_SECRET_KEY="your_secret"
export BARK_KEY="your_bark_key"
```

#### 防火墙配置

```bash
# 只允许必要的出站连接
# HTX WebSocket: wss://api.hbdm.com
# Bark API: https://api.day.app
```

### 3. 监控和日志

#### 日志管理

```bash
# 使用 PM2 日志轮转
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

#### 错误通知

程序会自动通过 Bark/Telegram 发送错误通知。

### 4. 性能优化

#### 调整 Node.js 内存限制

```bash
# 如果需要更多内存
node --max-old-space-size=512 realtime-pnl.js
```

#### 使用 PM2 集群模式（可选）

```bash
pm2 start realtime-pnl.js -i 1 --name htx-monitor
```

---

## 故障排查

### 1. 连接失败

```bash
# 检查网络连接
ping api.hbdm.com

# 检查 DNS
nslookup api.hbdm.com

# 测试 WebSocket 连接
npm run test:quick
```

### 2. 认证失败

```bash
# 检查 API 密钥
cat .env | grep HTX

# 验证配置
npm run check
```

### 3. 通知不工作

```bash
# 测试 Bark
npm run test:bark

# 测试 Telegram
npm run test:telegram

# 检查网络
curl https://api.day.app
```

### 4. 内存泄漏

```bash
# 使用 PM2 监控内存
pm2 monit

# 设置内存限制自动重启
pm2 start realtime-pnl.js --max-memory-restart 500M
```

---

## 更新部署

### 1. 拉取最新代码

```bash
git pull origin main
```

### 2. 安装新依赖

```bash
npm install
```

### 3. 检查配置

```bash
npm run build
```

### 4. 重启服务

```bash
# PM2
pm2 restart htx-monitor

# systemd
sudo systemctl restart htx-monitor

# Docker
docker restart htx-monitor
```

---

## 备份和恢复

### 备份配置

```bash
# 备份 .env 文件
cp .env .env.backup

# 备份整个项目
tar -czf htx-monitor-backup.tar.gz \
  --exclude=node_modules \
  --exclude=.git \
  .
```

### 恢复配置

```bash
# 恢复 .env
cp .env.backup .env

# 恢复项目
tar -xzf htx-monitor-backup.tar.gz
npm install
```

---

## 多实例部署

如果需要监控多个账户：

### 方法 1: 多个目录

```bash
# 账户 1
cd ~/htx-monitor-account1
npm start

# 账户 2
cd ~/htx-monitor-account2
npm start
```

### 方法 2: PM2 多实例

```bash
# 账户 1
pm2 start realtime-pnl.js --name htx-account1 -- --env .env.account1

# 账户 2
pm2 start realtime-pnl.js --name htx-account2 -- --env .env.account2
```

---

## 技术支持

如有问题，请查看：
- `README.md` - 项目说明
- `常见问题解答.md` - 常见问题
- `Bark配置指南.md` - Bark 配置
- `Telegram配置指南.md` - Telegram 配置

---

## 检查清单

部署前确认：

- [ ] Node.js 版本 >= 16
- [ ] 已安装依赖 (`npm install`)
- [ ] 已配置 .env 文件
- [ ] 已配置 HTX API 密钥
- [ ] 已配置至少一种通知方式（Bark 或 Telegram）
- [ ] 运行 `npm run build` 检查通过
- [ ] 测试通知功能正常
- [ ] 网络连接稳定

部署后确认：

- [ ] 程序正常运行
- [ ] 能收到测试通知
- [ ] 持仓数据正常显示
- [ ] 行情数据正常更新
- [ ] 日志输出正常
- [ ] 自动重连正常工作

---

祝部署顺利！🚀
