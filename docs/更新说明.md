# 更新说明

## v3.0.0 - 统一监控系统 🎉 (2026-02-04)

### 🚀 重大更新：合并持仓监控 + 行情监控

**之前：**
- `realtime-pnl.js` - 持仓盈亏监控
- `market-monitor.js` - 市场行情监控
- 两个独立程序，需要分别运行

**现在：**
- ✅ **统一为一个程序** `realtime-pnl.js`
- ✅ 同时监控持仓盈亏 + 市场趋势
- ✅ 共享市场 WebSocket 连接
- ✅ 统一的 Telegram 通知系统

---

## 功能特性

### 1. 持仓盈亏实时监控 💰

- 实时计算未实现盈亏
- 支持逐仓和全仓模式
- 智能通知（百分比 + 绝对金额）
- 自动订阅/取消订阅

**通知条件：**
- 盈利达到 3% 或 2 USDT
- 亏损达到 -5% 或 -2 USDT
- 持续上涨/下跌每变化 1%
- 每小时定时汇总

### 2. 市场行情趋势监控 📊

- 价格趋势分析（上涨/下跌/震荡）
- 趋势变化实时通知
- 可配置监控合约列表
- 无需持仓即可监控

**通知条件：**
- 趋势开始（neutral → up/down）
- 趋势持续（每变化 1%）
- 趋势反转（up ↔ down）
- 趋势结束（→ neutral）

### 3. 智能订阅管理 🎯

**问题：**
- 平仓后还在推送旧持仓数据
- 新开仓位没有自动订阅行情

**解决：**
- ✅ 平仓后自动取消行情订阅
- ✅ 新开仓自动订阅对应行情
- ✅ 合并持仓合约 + 监控合约
- ✅ 只计算和显示当前持仓

### 4. 统一通知系统 📱

- 持仓盈亏通知
- 市场趋势通知
- 定时汇总通知
- 防重复通知（5秒间隔）
- 自动检测 Telegram 配置

---

## 使用方法

### 快速开始

```bash
# 1. 配置 API 密钥
cp config.example.env .env
# 编辑 .env，填入 HTX_ACCESS_KEY 和 HTX_SECRET_KEY

# 2. 配置监控合约（可选）
# 编辑 market-config.js，添加要监控的合约

# 3. 配置 Telegram（可选）
# 在 .env 中添加 TELEGRAM_BOT_TOKEN 和 TELEGRAM_CHAT_ID

# 4. 启动统一监控
npm start
# 或
node realtime-pnl.js
```

### 配置文件

**`market-config.js`** - 市场监控配置

```javascript
export const marketConfig = {
  // 要监控的合约列表
  watchContracts: [
    'BTC-USDT',
    'ETH-USDT',
    // 可以添加更多合约
  ],

  // 趋势判断配置
  trendConfig: {
    priceHistorySize: 10,      // 保留最近 10 个价格点
    trendThreshold: 0.7,       // 70% 同向即判定为趋势
    minPricePoints: 5,         // 至少需要 5 个价格点
  },

  // 通知配置
  notifyConfig: {
    trendChangePercent: 1.0,   // 趋势持续变化 1% 时通知
    repeatInterval: 5 * 1000,  // 5 秒防重复
  },
};
```

**`realtime-pnl.js`** - 持仓监控配置

```javascript
const notifier = new TelegramNotifier(TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, {
  profitThreshold: 3,                    // 盈利 3% 时通知
  lossThreshold: -5,                     // 亏损 5% 时通知
  profitAmountThreshold: 2,              // 盈利 2 USDT 时通知
  lossAmountThreshold: -2,               // 亏损 2 USDT 时通知
  timeInterval: 60 * 60 * 1000,          // 1 小时定时通知
  repeatInterval: 5 * 1000,              // 5 秒防重复
});
```

---

## 运行示例

### 启动输出

```
🚀 HTX 统一监控启动中...

📊 功能：
   ✅ 持仓盈亏实时监控
   ✅ 市场行情趋势监控
   ✅ Telegram 智能通知

📱 检测到 Telegram 配置，启用通知功能...
✅ Telegram 通知测试成功

📡 订阅持仓更新...
✓ 已订阅：逐仓持仓更新（所有合约）
✓ 已订阅：全仓持仓更新（所有合约）

📊 持仓检查: 1 个持仓
📋 持仓合约: ETH-USDT

📊 连接市场行情 WebSocket...
✅ 市场行情连接成功

📡 订阅行情: BTC-USDT, ETH-USDT
   → BTC-USDT (监控合约)
   → ETH-USDT (持仓合约)

✅ 监听已启动

💡 持仓监控配置：
   盈利通知: 3% 或 2 USDT
   亏损通知: -5% 或 -2 USDT
   定时通知: 每 60 分钟

💡 行情监控配置：
   监控合约: BTC-USDT, ETH-USDT
   趋势判断: 最近 10 个价格点，70% 同向
   通知条件: 趋势变化 1%
```

### 持仓盈亏监控

```
🔴 [12:00:00] ETH-USDT 空仓
   持仓: 21 张 × 0.01 = 0.2100 ETH
   持仓价值: 479.22 USDT | 保证金: 47.93 USDT
   最新价: 2282.00 | 开仓价: 2273.76
   未实现盈亏: -1.7304 USDT | 收益率: -3.61%
```

### 市场趋势监控

```
📈 [行情] BTC-USDT: 76452.30 (+0.02%)
📉 [行情] ETH-USDT: 2281.49 (-0.15%)
```

### Telegram 通知

**持仓盈亏通知：**
```
🎉 盈利提醒

🟢 ETH-USDT 空仓

📊 持仓信息
持仓量: 21 张 (0.2100 ETH)
持仓价值: 479.22 USDT
保证金: 47.93 USDT

💰 价格信息
最新价: 2282.00 USDT
开仓价: 2273.76 USDT
价差: 8.24 USDT

📈 盈亏情况
未实现盈亏: 1.7304 USDT
收益率: 3.61%

⏰ 2026/2/4 12:00:00
```

**市场趋势通知：**
```
📈 行情提醒

🟢 BTC-USDT

📊 价格信息
当前价格: 76452.30 USDT
价格变化: +152.30 USDT
变化幅度: +0.20%

🎯 趋势分析
当前趋势: 上涨 📈
触发原因: 开始上涨趋势

⏰ 2026/2/4 12:00:00
```

---

## 工作原理

### 订阅管理流程

```javascript
// 1. 持仓更新时
client.on('positions', (data) => {
  // 清空旧持仓
  positions.clear();
  
  // 收集当前持仓的合约
  const currentContracts = new Set();
  data.forEach(position => {
    if (position.volume > 0) {
      positions.set(key, position);
      currentContracts.add(position.contract_code);
    }
  });
  
  // 更新市场订阅
  updateMarketSubscriptions(currentContracts);
});

// 2. 更新订阅
function updateMarketSubscriptions(currentContracts) {
  // 取消已平仓合约的订阅（如果不在监控列表）
  subscribedContracts.forEach(contract => {
    if (!currentContracts.has(contract) && !watchContracts.includes(contract)) {
      console.log(`📉 取消订阅: ${contract} (已平仓且不在监控列表)`);
      // 发送取消订阅消息
    }
  });
  
  // 订阅新开仓合约
  currentContracts.forEach(contract => {
    if (!subscribedContracts.has(contract)) {
      console.log(`📈 新增订阅: ${contract} (新开仓)`);
      // 发送订阅消息
    }
  });
}

// 3. 市场连接时
marketWs.on('open', () => {
  // 合并持仓合约和监控合约
  const allContracts = new Set([
    ...Array.from(positions.values()).map(p => p.contract_code),
    ...watchContracts
  ]);
  
  // 订阅所有合约
  allContracts.forEach(contract => {
    marketWs.send(JSON.stringify({
      sub: `market.${contract}.detail`,
      id: `detail_${contract}`
    }));
  });
});

// 4. 收到行情数据
marketWs.on('message', (data) => {
  const contractCode = extractContractCode(data);
  const lastPrice = extractPrice(data);
  
  // 计算持仓盈亏
  calculatePnL(contractCode, lastPrice);
  
  // 分析市场趋势
  analyzeTrend(contractCode, lastPrice);
});
```

---

## 优势

### 1. 统一管理

- 一个程序监控所有数据
- 不需要运行多个脚本
- 配置集中管理

### 2. 资源优化

- 共享市场 WebSocket 连接
- 避免重复订阅
- 减少网络流量

### 3. 智能订阅

- 自动跟踪持仓变化
- 自动管理行情订阅
- 避免无效数据推送

### 4. 灵活配置

- Telegram 可选
- 监控合约可配置
- 通知阈值可调整

---

## 文件说明

### 主程序
- ✅ `realtime-pnl.js` - 统一监控主程序（推荐使用）
- ⚠️ `market-monitor.js` - 独立市场监控（已废弃，功能已合并）
- ⚠️ `index.js` - 基础监听（旧版，保留用于参考）

### 配置文件
- ✅ `market-config.js` - 市场监控配置
- ✅ `.env` - API 密钥和 Telegram 配置

### 工具模块
- ✅ `telegram-notifier.js` - 通知逻辑
- ✅ `client.js` - HTX WebSocket 客户端
- ✅ `auth.js` - 认证工具

### 测试脚本
- ✅ `test-telegram.js` - 测试 Telegram 通知
- ✅ `test-positions.js` - 测试持仓数据

---

## 迁移指南

### 从 `market-monitor.js` 迁移

```bash
# 之前：单独运行市场监控
node market-monitor.js

# 现在：使用统一监控（自动包含市场监控）
npm start
```

配置文件 `market-config.js` 保持不变。

### 从旧版 `realtime-pnl.js` 升级

```bash
# 直接运行新版本即可
npm start
```

新增功能：
- ✅ 市场趋势监控
- ✅ 趋势变化通知
- ✅ 智能订阅管理

---

## 常见问题

### Q: 我只想监控持仓，不想监控市场趋势？

A: 在 `market-config.js` 中设置空数组：

```javascript
watchContracts: [],  // 不监控任何市场
```

### Q: 我只想监控市场，没有持仓？

A: 没问题！程序会自动检测：
- 有持仓 → 监控持仓 + 市场
- 无持仓 → 只监控市场

### Q: 可以同时监控多个合约吗？

A: 可以！在 `market-config.js` 中添加：

```javascript
watchContracts: [
  'BTC-USDT',
  'ETH-USDT',
  'SOL-USDT',
  'DOGE-USDT',
  // 添加更多...
],
```

### Q: 不想用 Telegram 通知？

A: 不配置即可：
- 删除或注释 `.env` 中的 `TELEGRAM_BOT_TOKEN` 和 `TELEGRAM_CHAT_ID`
- 程序会自动检测并只显示控制台输出

---

## 总结

✅ **统一监控系统**
- 持仓盈亏 + 市场趋势
- 一个程序搞定所有功能

✅ **智能订阅管理**
- 自动订阅/取消订阅
- 合并持仓合约 + 监控合约

✅ **灵活配置**
- Telegram 可选
- 监控合约可配置
- 通知阈值可调整

✅ **资源优化**
- 共享 WebSocket 连接
- 避免重复订阅
- 减少网络流量

祝交易顺利！🚀
