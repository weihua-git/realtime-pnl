# å®ç›˜é€»è¾‘å®¡æŸ¥æŠ¥å‘Š

## ğŸ“‹ å®¡æŸ¥æ¦‚è¿°

**å®¡æŸ¥æ—¶é—´**: 2026-02-07  
**å®¡æŸ¥èŒƒå›´**: é‡åŒ–äº¤æ˜“å®ç›˜é€»è¾‘  
**ä¸»è¦æ–‡ä»¶**: 
- `src/services/quant-trader.js`
- `src/services/trading-engine.js`
- `realtime-pnl.js`

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

### 1. âŒ æ­¢ç›ˆæ­¢æŸè®¢å•ç¼ºå°‘ `offset` å‚æ•°

**ä½ç½®**: `quant-trader.js` - `setTPSLOrder()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âŒ é”™è¯¯ï¼šç¼ºå°‘ offset å‚æ•°
const params = {
  contract_code: this.config.symbol,
  direction: direction === 'long' ? 'sell' : 'buy',
  volume: Math.floor(size),
  // ç¼ºå°‘ offset: 'close' âŒ
  sl_trigger_price: stopLossPrice.toFixed(2),
  // ...
};
```

**é£é™©ç­‰çº§**: ğŸ”´ ä¸¥é‡ - å¯èƒ½å¯¼è‡´æ­¢ç›ˆæ­¢æŸè®¢å•åˆ›å»ºå¤±è´¥ï¼ŒæŒä»“å®Œå…¨æ— ä¿æŠ¤

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ­£ç¡®ï¼šæ·»åŠ  offset å‚æ•°
const params = {
  contract_code: this.config.symbol,
  direction: direction === 'long' ? 'sell' : 'buy',
  volume: Math.floor(size),
  offset: 'close', // âœ… å¿…é¡»æŒ‡å®šä¸ºå¹³ä»“
  sl_trigger_price: stopLossPrice.toFixed(2),
  // ...
};
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 2. âŒ æ­¢ç›ˆæ­¢æŸè®¾ç½®å¤±è´¥åæ²¡æœ‰å›æ»šæœºåˆ¶

**ä½ç½®**: `quant-trader.js` - `placeOrderWithTPSL()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âŒ é”™è¯¯ï¼šå¼€ä»“æˆåŠŸä½†æ­¢ç›ˆæ­¢æŸå¤±è´¥ï¼ŒæŒä»“æ— ä¿æŠ¤
const openSuccess = await this.placeOrder(direction, size, 'open');
if (!openSuccess) {
  return false;
}

// å¦‚æœè¿™é‡Œå¤±è´¥ï¼ŒæŒä»“å°†å®Œå…¨æ²¡æœ‰ä¿æŠ¤ï¼âŒ
await this.setTPSLOrder(direction, size, stopLossPrice, takeProfitPrice);

return true; // å³ä½¿æ­¢ç›ˆæ­¢æŸå¤±è´¥ä¹Ÿè¿”å› true âŒ
```

**é£é™©ç­‰çº§**: ğŸ”´ è‡´å‘½ - æŒä»“å¯èƒ½å®Œå…¨æ²¡æœ‰æ­¢æŸä¿æŠ¤ï¼Œé¢ä¸´çˆ†ä»“é£é™©

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ­£ç¡®ï¼šæ£€æŸ¥æ­¢ç›ˆæ­¢æŸç»“æœï¼Œå¤±è´¥åˆ™ç«‹å³å¹³ä»“
const tpslResult = await this.setTPSLOrder(direction, size, stopLossPrice, takeProfitPrice);

if (!tpslResult.success) {
  logger.error('âŒ æ­¢ç›ˆæ­¢æŸè®¾ç½®å¤±è´¥ï¼Œç«‹å³å¹³ä»“ä¿æŠ¤èµ„é‡‘ï¼');
  const closeDirection = direction === 'long' ? 'sell' : 'buy';
  await this.placeOrder(closeDirection, size, 'close');
  return false;
}
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 3. âŒ å®ç›˜æŒä»“æ•°æ®åŒæ­¥ä¸¢å¤±å†å²è¿½è¸ª

**ä½ç½®**: `quant-trader.js` - `onPositionsUpdate()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½æ¸…ç©ºæŒä»“ï¼Œä¸¢å¤± highestPrice/lowestPrice
onPositionsUpdate(positionsData) {
  this.positions = []; // âŒ ç›´æ¥æ¸…ç©ºï¼Œä¸¢å¤±å†å²æ•°æ®
  
  positionsData.forEach(pos => {
    this.positions.push({
      // ...
      highestPrice: pos.direction === 'buy' ? Number(pos.cost_open) : null, // âŒ é‡ç½®ä¸ºå¼€ä»“ä»·
      lowestPrice: pos.direction === 'sell' ? Number(pos.cost_open) : null,
    });
  });
}
```

**é£é™©ç­‰çº§**: ğŸ”´ ä¸¥é‡ - ç§»åŠ¨æ­¢æŸåŠŸèƒ½å®Œå…¨å¤±æ•ˆ

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ­£ç¡®ï¼šæ™ºèƒ½åˆå¹¶ï¼Œä¿ç•™å†å²è¿½è¸ªæ•°æ®
onPositionsUpdate(positionsData) {
  const newPositions = [];
  
  positionsData.forEach(pos => {
    const direction = pos.direction === 'buy' ? 'long' : 'short';
    const existingPos = this.positions.find(p => p.direction === direction);
    
    if (existingPos) {
      // ä¿ç•™å†å²è¿½è¸ªæ•°æ®
      newPositions.push({
        ...existingPos,
        entryPrice: Number(pos.cost_open),
        size: Number(pos.volume),
        // highestPrice/lowestPrice ä¿ç•™ âœ…
      });
    } else {
      // æ–°æŒä»“
      newPositions.push({ /* ... */ });
    }
  });
  
  this.positions = newPositions;
}
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 4. âŒ æ‰‹ç»­è´¹è®¡ç®—é”™è¯¯

**ä½ç½®**: `quant-trader.js` - `openPosition()` å’Œ `closePosition()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âŒ é”™è¯¯ï¼šæ‰‹ç»­è´¹åº”è¯¥åŸºäºå®é™…æˆäº¤é‡‘é¢ï¼Œè€Œä¸æ˜¯ä¿è¯é‡‘
const openFee = positionValue * this.config.takerFee; // âŒ positionValue æ˜¯ä¿è¯é‡‘
```

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ - æ‰‹ç»­è´¹è®¡ç®—åä½ï¼Œç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®

**æ­£ç¡®å…¬å¼**:
- å®é™…æˆäº¤é‡‘é¢ = ä¿è¯é‡‘ Ã— æ æ†
- æ‰‹ç»­è´¹ = å®é™…æˆäº¤é‡‘é¢ Ã— è´¹ç‡

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ­£ç¡®ï¼šåŸºäºå®é™…æˆäº¤é‡‘é¢è®¡ç®—
const actualTradeValue = positionValue * this.config.leverage;
const openFee = actualTradeValue * this.config.takerFee;
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 5. âŒ å¹³ä»“åæœªä¸»åŠ¨å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å•

**ä½ç½®**: `quant-trader.js` - `closePosition()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âŒ é”™è¯¯ï¼šå‡è®¾æ­¢ç›ˆæ­¢æŸä¼šè‡ªåŠ¨å¤±æ•ˆ
const success = await this.placeOrder(closeDirection, size, 'close');
if (!success) {
  logger.error(`âŒ å®ç›˜å¹³ä»“å¤±è´¥ï¼Œä¿ç•™æŒä»“`);
  return;
}
// æ²¡æœ‰å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å• âŒ
```

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ - å¯èƒ½æ®‹ç•™æ­¢ç›ˆæ­¢æŸè®¢å•ï¼Œå½±å“åç»­äº¤æ˜“

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ­£ç¡®ï¼šä¸»åŠ¨å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å•
const success = await this.placeOrder(closeDirection, size, 'close');
if (!success) {
  logger.error(`âŒ å®ç›˜å¹³ä»“å¤±è´¥ï¼Œä¿ç•™æŒä»“`);
  return;
}

// ä¸»åŠ¨å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å•
try {
  await this.cancelTPSLOrders(this.config.symbol, direction);
  logger.debug('âœ… å·²å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å•');
} catch (error) {
  logger.warn('âš ï¸ å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å•å¤±è´¥ï¼ˆå¯èƒ½å·²è‡ªåŠ¨å¤±æ•ˆï¼‰:', error.message);
}
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤ï¼ˆæ–°å¢ `cancelTPSLOrders()` æ–¹æ³•ï¼‰

---

## ğŸ”´ æ–°å‘ç°çš„ä¸¥é‡é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

### 6. âŒ æµ‹è¯•æ¨¡å¼ä¸‹æ‰‹ç»­è´¹æ‰£é™¤æ—¶æœºé”™è¯¯

**ä½ç½®**: `quant-trader.js` - `openPosition()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âŒ é”™è¯¯ï¼šæ‰‹ç»­è´¹åœ¨å¼€ä»“å‰å°±æ‰£é™¤ï¼Œä½†å¦‚æœå¼ æ•°ä¸è¶³ï¼Œæ‰‹ç»­è´¹å·²æ‰£é™¤ä½†æ²¡æœ‰é€€è¿˜
const openFee = actualTradeValue * this.config.takerFee;
this.balance -= openFee; // âŒ æå‰æ‰£é™¤

if (roundedSize < 1) {
  logger.warn(`è®¡ç®—å¼ æ•°ä¸è¶³1å¼ ï¼Œå–æ¶ˆå¼€ä»“`);
  return; // âŒ ç›´æ¥è¿”å›ï¼Œæ‰‹ç»­è´¹æ²¡æœ‰é€€è¿˜
}
```

**é£é™©ç­‰çº§**: ğŸ”´ ä¸¥é‡ - æµ‹è¯•æ¨¡å¼ä¸‹å¯èƒ½å¯¼è‡´ä½™é¢è®¡ç®—é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ­£ç¡®ï¼šå…ˆéªŒè¯æ‰€æœ‰æ¡ä»¶ï¼Œæœ€åæ‰æ‰£é™¤æ‰‹ç»­è´¹
if (roundedSize < 1) {
  logger.warn(`è®¡ç®—å¼ æ•°ä¸è¶³1å¼ ï¼Œå–æ¶ˆå¼€ä»“`);
  return;
}

// å®ç›˜æ¨¡å¼ï¼šå…ˆè°ƒç”¨API
if (!this.config.testMode) {
  openSuccess = await this.placeOrderWithTPSL(direction, roundedSize, price);
  if (!openSuccess) {
    return; // å¼€ä»“å¤±è´¥ï¼Œä¸æ‰£é™¤æ‰‹ç»­è´¹
  }
}

// å¼€ä»“æˆåŠŸåæ‰æ‰£é™¤æ‰‹ç»­è´¹
this.balance -= openFee;
this.stats.totalFees += openFee;
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 7. âŒ å®ç›˜æ¨¡å¼ä¸‹æ‰‹ç»­è´¹æ‰£é™¤é€»è¾‘é”™è¯¯

**ä½ç½®**: `quant-trader.js` - `openPosition()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âŒ é”™è¯¯ï¼šå®ç›˜æ¨¡å¼ä¸‹ï¼Œæ‰‹ç»­è´¹åœ¨APIè°ƒç”¨å‰å°±æ‰£é™¤
this.balance -= openFee; // âŒ æå‰æ‰£é™¤

const position = { /* ... */ };

// å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œæ‰‹ç»­è´¹å·²ç»æ‰£é™¤ä½†éœ€è¦é€€è¿˜
const success = await this.placeOrderWithTPSL(direction, roundedSize, price);
if (!success) {
  this.balance += openFee; // âŒ éœ€è¦æ‰‹åŠ¨é€€è¿˜
  this.stats.totalFees -= openFee;
  return;
}
```

**é£é™©ç­‰çº§**: ğŸ”´ ä¸¥é‡ - å®ç›˜å¼€ä»“å¤±è´¥æ—¶ä½™é¢è®¡ç®—å¯èƒ½å‡ºé”™

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ­£ç¡®ï¼šå…ˆè°ƒç”¨APIï¼ŒæˆåŠŸåæ‰æ‰£é™¤æ‰‹ç»­è´¹
if (!this.config.testMode) {
  openSuccess = await this.placeOrderWithTPSL(direction, roundedSize, price);
  if (!openSuccess) {
    logger.error(`âŒ å®ç›˜å¼€ä»“å¤±è´¥ï¼Œå–æ¶ˆæœ¬æ¬¡äº¤æ˜“`);
    return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰£é™¤æ‰‹ç»­è´¹
  }
}

// APIè°ƒç”¨æˆåŠŸåæ‰æ‰£é™¤æ‰‹ç»­è´¹
this.balance -= openFee;
this.stats.totalFees += openFee;
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 8. âŒ ç¼ºå°‘ä½™é¢å……è¶³æ€§æ£€æŸ¥

**ä½ç½®**: `quant-trader.js` - `openPosition()` æ–¹æ³•

**é—®é¢˜æè¿°**:
- æµ‹è¯•æ¨¡å¼ä¸‹æ²¡æœ‰æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
- å¯èƒ½å¯¼è‡´ä½™é¢å˜ä¸ºè´Ÿæ•°

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ - æµ‹è¯•æ¨¡å¼ä¸‹å¯èƒ½å‡ºç°è´Ÿä½™é¢

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æ–°å¢ï¼šæ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
if (this.config.testMode && positionValue > this.balance) {
  logger.warn(`âŒ ä½™é¢ä¸è¶³ï¼šéœ€è¦ ${positionValue.toFixed(2)} USDTï¼Œå½“å‰ä½™é¢ ${this.balance.toFixed(2)} USDT`);
  return;
}

// âœ… æ–°å¢ï¼šæ£€æŸ¥æ‰£é™¤æ‰‹ç»­è´¹åä½™é¢æ˜¯å¦ä¸ºè´Ÿ
if (this.config.testMode && (this.balance - openFee) < 0) {
  logger.warn(`âŒ æ‰£é™¤æ‰‹ç»­è´¹åä½™é¢ä¸è¶³ï¼šæ‰‹ç»­è´¹ ${openFee.toFixed(4)} USDTï¼Œå½“å‰ä½™é¢ ${this.balance.toFixed(2)} USDT`);
  return;
}
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## âš ï¸ ä¸­ç­‰é£é™©é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

### 9. âš ï¸ ä»·æ ¼å˜åŒ–è§¦å‘é˜ˆå€¼è¿‡ä½

**ä½ç½®**: `quant-trader.js` - `onPriceUpdate()` æ–¹æ³•

**é—®é¢˜æè¿°**:
```javascript
// âš ï¸ 0.1% çš„é˜ˆå€¼å¤ªä½ï¼Œå¯èƒ½å¯¼è‡´ API é™æµ
const shouldCheck = priceChangePercent >= 0.001 || timeSinceLastCheck > 30000;
```

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ - å¯èƒ½è§¦å‘ç«å¸ API é™æµï¼ˆæ¯ç§’æœ€å¤š 10 æ¬¡è¯·æ±‚ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// âœ… æé«˜åˆ° 0.3%ï¼Œå‡å°‘ API è°ƒç”¨é¢‘ç‡
const shouldCheck = priceChangePercent >= 0.003 || timeSinceLastCheck > 30000;
```

**ä¿®å¤çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ’¡ å…¶ä»–å»ºè®®

### 10. å»ºè®®ï¼šå¢åŠ è®¢å•çŠ¶æ€éªŒè¯

**å½“å‰é—®é¢˜**: ä¸‹å•åæ²¡æœ‰éªŒè¯è®¢å•æ˜¯å¦çœŸæ­£æˆäº¤

**å»ºè®®æ–¹æ¡ˆ**:
```javascript
// å»ºè®®ï¼šä¸‹å•åæŸ¥è¯¢è®¢å•çŠ¶æ€
async placeOrder(direction, size, offset = 'open') {
  // ... ä¸‹å•é€»è¾‘ ...
  
  if (response.data.status === 'ok') {
    const orderId = response.data.data.order_id;
    
    // ç­‰å¾… 1 ç§’åæŸ¥è¯¢è®¢å•çŠ¶æ€
    await new Promise(resolve => setTimeout(resolve, 1000));
    const orderInfo = await this.queryOrder(orderId);
    
    if (orderInfo.status === 6) { // 6 = å…¨éƒ¨æˆäº¤
      return true;
    } else {
      logger.warn(`è®¢å•æœªå®Œå…¨æˆäº¤: ${orderInfo.status}`);
      return false;
    }
  }
}
```

### 11. å»ºè®®ï¼šå¢åŠ èµ„é‡‘å®‰å…¨æ£€æŸ¥ï¼ˆå®ç›˜æ¨¡å¼ï¼‰

**å»ºè®®æ–¹æ¡ˆ**:
```javascript
// å»ºè®®ï¼šå¼€ä»“å‰æ£€æŸ¥è´¦æˆ·ä½™é¢
async openPosition(direction, price, suggestion) {
  // å®ç›˜æ¨¡å¼ï¼šå…ˆæŸ¥è¯¢è´¦æˆ·ä½™é¢
  if (!this.config.testMode) {
    const accountInfo = await this.getAccountInfo();
    if (accountInfo.available < positionValue) {
      logger.error('âŒ è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œå–æ¶ˆå¼€ä»“');
      return;
    }
  }
  
  // ... å¼€ä»“é€»è¾‘ ...
}
```

### 12. å»ºè®®ï¼šå¢åŠ å¼‚å¸¸æƒ…å†µå‘Šè­¦

**å»ºè®®æ–¹æ¡ˆ**:
```javascript
// å»ºè®®ï¼šå…³é”®æ“ä½œå¤±è´¥æ—¶å‘é€ç´§æ€¥é€šçŸ¥
if (!tpslResult.success) {
  logger.error('âŒ æ­¢ç›ˆæ­¢æŸè®¾ç½®å¤±è´¥ï¼Œç«‹å³å¹³ä»“ä¿æŠ¤èµ„é‡‘ï¼');
  
  // å‘é€ç´§æ€¥é€šçŸ¥ï¼ˆTelegram/Barkï¼‰
  await this.sendEmergencyAlert({
    title: 'ğŸš¨ ç´§æ€¥ï¼šæ­¢ç›ˆæ­¢æŸè®¾ç½®å¤±è´¥',
    message: `${this.config.symbol} ${direction} æŒä»“æ— ä¿æŠ¤ï¼Œå·²è‡ªåŠ¨å¹³ä»“`,
    level: 'critical'
  });
  
  // ç«‹å³å¹³ä»“
  const closeDirection = direction === 'long' ? 'sell' : 'buy';
  await this.placeOrder(closeDirection, size, 'close');
  return false;
}
```

---

## ğŸ“Š ç«å¸ API ä½¿ç”¨è§„èŒƒ

### API é™æµè§„åˆ™

æ ¹æ®ç«å¸å®˜æ–¹æ–‡æ¡£ï¼š

| æ¥å£ç±»å‹ | é™æµè§„åˆ™ |
|---------|---------|
| ä¸‹å•æ¥å£ | 10æ¬¡/ç§’ |
| æŸ¥è¯¢æ¥å£ | 20æ¬¡/ç§’ |
| WebSocket | æ¯ä¸ªè¿æ¥æœ€å¤šè®¢é˜… 30 ä¸ªé¢‘é“ |

**å½“å‰ä»£ç çš„ API è°ƒç”¨é¢‘ç‡**:
- âœ… ä¿¡å·æ£€æŸ¥ï¼š0.3% ä»·æ ¼å˜åŒ–æˆ– 30 ç§’ï¼ˆç¬¦åˆè§„èŒƒï¼‰
- âœ… æŒä»“åˆ†æï¼š0.3% ä»·æ ¼å˜åŒ–æˆ– 60 ç§’ï¼ˆç¬¦åˆè§„èŒƒï¼‰

### æ­¢ç›ˆæ­¢æŸè®¢å•å‚æ•°

**å¿…éœ€å‚æ•°**:
```javascript
{
  contract_code: "BTC-USDT",     // åˆçº¦ä»£ç 
  direction: "sell",              // å¹³ä»“æ–¹å‘ï¼ˆä¸æŒä»“ç›¸åï¼‰
  volume: 1,                      // å¼ æ•°ï¼ˆæ•´æ•°ï¼‰
  offset: "close",                // âœ… å¿…é¡»æŒ‡å®šä¸º close
  sl_trigger_price: "50000",      // æ­¢æŸè§¦å‘ä»·
  sl_order_price: "50000",        // æ­¢æŸå§”æ‰˜ä»·
  sl_order_price_type: "optimal_5", // å¯¹æ‰‹ä»·
  tp_trigger_price: "52000",      // æ­¢ç›ˆè§¦å‘ä»·
  tp_order_price: "52000",        // æ­¢ç›ˆå§”æ‰˜ä»·
  tp_order_price_type: "optimal_5"  // å¯¹æ‰‹ä»·
}
```

### ç›ˆäºè®¡ç®—å…¬å¼

**ç«å¸å®˜æ–¹å…¬å¼**:
```
å¤šä»“ç›ˆäº = (å¹³ä»“ä»· - å¼€ä»“ä»·) Ã— é¢å€¼ Ã— å¼ æ•°
ç©ºä»“ç›ˆäº = (å¼€ä»“ä»· - å¹³ä»“ä»·) Ã— é¢å€¼ Ã— å¼ æ•°

ROE = ç›ˆäº / ä¿è¯é‡‘ Ã— 100%
```

**å½“å‰ä»£ç å®ç°**:
```javascript
// âœ… ç®€åŒ–ä½†ç­‰ä»·çš„å®ç°
const priceChangePercent = (currentPrice - entryPrice) / entryPrice;
const profitUSDT = priceChangePercent * positionValue; // positionValue = ä¿è¯é‡‘ Ã— æ æ†
const roe = profitUSDT / margin; // margin = positionValue / leverage
```

---

## âœ… ä¿®å¤æ€»ç»“

### å·²ä¿®å¤çš„é—®é¢˜

1. âœ… æ­¢ç›ˆæ­¢æŸè®¢å•æ·»åŠ  `offset: 'close'` å‚æ•°
2. âœ… æ­¢ç›ˆæ­¢æŸå¤±è´¥åå¢åŠ å›æ»šæœºåˆ¶ï¼ˆç«‹å³å¹³ä»“ï¼‰
3. âœ… å®ç›˜æŒä»“åŒæ­¥ä¿ç•™å†å²è¿½è¸ªæ•°æ®
4. âœ… ä¿®æ­£æ‰‹ç»­è´¹è®¡ç®—å…¬å¼ï¼ˆåŸºäºå®é™…æˆäº¤é‡‘é¢ï¼‰
5. âœ… å¹³ä»“åä¸»åŠ¨å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å•
6. âœ… æé«˜ä»·æ ¼å˜åŒ–è§¦å‘é˜ˆå€¼ï¼ˆ0.1% â†’ 0.3%ï¼‰
7. âœ… æ–°å¢ `cancelTPSLOrders()` æ–¹æ³•
8. âœ… ä¿®æ­£æ‰‹ç»­è´¹æ‰£é™¤æ—¶æœºï¼ˆå¼€ä»“æˆåŠŸåæ‰æ‰£é™¤ï¼‰
9. âœ… æ–°å¢ä½™é¢å……è¶³æ€§æ£€æŸ¥ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
10. âœ… å‰ç«¯æ˜¾ç¤ºå¼€ä»“æ‰‹ç»­è´¹

### ä¿®å¤åçš„é£é™©ç­‰çº§

| é£é™©ç±»å‹ | ä¿®å¤å‰ | ä¿®å¤å |
|---------|-------|-------|
| æ­¢ç›ˆæ­¢æŸå¤±æ•ˆ | ğŸ”´ ä¸¥é‡ | ğŸŸ¢ å®‰å…¨ |
| æŒä»“æ— ä¿æŠ¤ | ğŸ”´ è‡´å‘½ | ğŸŸ¢ å®‰å…¨ |
| ç§»åŠ¨æ­¢æŸå¤±æ•ˆ | ğŸ”´ ä¸¥é‡ | ğŸŸ¢ å®‰å…¨ |
| API é™æµ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ å®‰å…¨ |
| æ‰‹ç»­è´¹è®¡ç®— | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ å‡†ç¡® |
| æ‰‹ç»­è´¹æ‰£é™¤æ—¶æœº | ğŸ”´ ä¸¥é‡ | ğŸŸ¢ å®‰å…¨ |
| ä½™é¢æ£€æŸ¥ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ å®‰å…¨ |

---

## ğŸ” æµ‹è¯•å»ºè®®

### 1. æµ‹è¯•æ¨¡å¼éªŒè¯

```bash
# 1. å¯åŠ¨æµ‹è¯•æ¨¡å¼
QUANT_ENABLED=true QUANT_TEST_MODE=true node realtime-pnl.js

# 2. è§‚å¯Ÿæ—¥å¿—ï¼Œç¡®è®¤ï¼š
#    - æ­¢ç›ˆæ­¢æŸè®¢å•è®¾ç½®æˆåŠŸ
#    - æŒä»“è¿½è¸ªæ•°æ®æ­£ç¡®
#    - æ‰‹ç»­è´¹è®¡ç®—å‡†ç¡®
```

### 2. å®ç›˜å‰æ£€æŸ¥æ¸…å•

- [ ] ç¡®è®¤ API Key æƒé™ï¼ˆéœ€è¦äº¤æ˜“æƒé™ï¼‰
- [ ] ç¡®è®¤è´¦æˆ·ä½™é¢å……è¶³
- [ ] ç¡®è®¤æ æ†å€æ•°è®¾ç½®æ­£ç¡®
- [ ] ç¡®è®¤æ­¢æŸæ­¢ç›ˆå‚æ•°åˆç†
- [ ] å°ä»“ä½æµ‹è¯•ï¼ˆå»ºè®® 10 USDT ä»¥ä¸‹ï¼‰
- [ ] ç›‘æ§æ—¥å¿—è¾“å‡º
- [ ] å‡†å¤‡æ‰‹åŠ¨å¹³ä»“æ–¹æ¡ˆ

### 3. ç›‘æ§è¦ç‚¹

```javascript
// å…³é”®æ—¥å¿—ç›‘æ§
logger.info('âœ… æ­¢ç›ˆæ­¢æŸè®¢å•è®¾ç½®æˆåŠŸ (è®¢å•ID: xxx)'); // âœ… å¿…é¡»çœ‹åˆ°
logger.error('âŒ æ­¢ç›ˆæ­¢æŸè®¾ç½®å¤±è´¥ï¼Œç«‹å³å¹³ä»“ä¿æŠ¤èµ„é‡‘ï¼'); // ğŸš¨ ç´§æ€¥å‘Šè­¦
logger.info('âœ… å·²å–æ¶ˆæ­¢ç›ˆæ­¢æŸè®¢å•'); // âœ… å¹³ä»“åç¡®è®¤
```

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [ç«å¸åˆçº¦ API æ–‡æ¡£](https://huobiapi.github.io/docs/usdt_swap/v1/cn/)
- [æ­¢ç›ˆæ­¢æŸè®¢å•æ¥å£](https://huobiapi.github.io/docs/usdt_swap/v1/cn/#0a9b6ea149)
- [åˆçº¦ä¸‹å•æ¥å£](https://huobiapi.github.io/docs/usdt_swap/v1/cn/#5ea6e1f3db)
- [API é™æµè§„åˆ™](https://huobiapi.github.io/docs/usdt_swap/v1/cn/#api-2)

---

## ğŸ¯ ç»“è®º

ç»è¿‡å®¡æŸ¥å’Œä¿®å¤ï¼Œ**å®ç›˜é€»è¾‘çš„ä¸»è¦é£é™©å·²ç»æ¶ˆé™¤**ã€‚ä¿®å¤åçš„ä»£ç ï¼š

âœ… **æ­¢ç›ˆæ­¢æŸä¿æŠ¤å®Œå–„** - å¼€ä»“å¤±è´¥ä¼šè‡ªåŠ¨å›æ»š  
âœ… **æŒä»“æ•°æ®åŒæ­¥æ­£ç¡®** - ç§»åŠ¨æ­¢æŸåŠŸèƒ½æ­£å¸¸  
âœ… **æ‰‹ç»­è´¹è®¡ç®—å‡†ç¡®** - ç»Ÿè®¡æ•°æ®å¯é   
âœ… **API è°ƒç”¨é¢‘ç‡åˆç†** - ä¸ä¼šè§¦å‘é™æµ  
âœ… **è®¢å•ç®¡ç†å®Œå–„** - å¹³ä»“åæ¸…ç†æ­¢ç›ˆæ­¢æŸè®¢å•  

**å»ºè®®**ï¼š
1. å…ˆåœ¨æµ‹è¯•æ¨¡å¼ä¸‹è¿è¡Œ 24 å°æ—¶ï¼Œè§‚å¯Ÿç¨³å®šæ€§
2. å®ç›˜å‰ä½¿ç”¨æœ€å°ä»“ä½ï¼ˆ10-20 USDTï¼‰æµ‹è¯•
3. å¯†åˆ‡ç›‘æ§æ—¥å¿—ï¼Œç‰¹åˆ«æ˜¯æ­¢ç›ˆæ­¢æŸç›¸å…³æ—¥å¿—
4. å‡†å¤‡æ‰‹åŠ¨å¹³ä»“é¢„æ¡ˆï¼ˆç«å¸ APP æˆ–ç½‘é¡µç«¯ï¼‰

---

**å®¡æŸ¥äºº**: Claude (AI Assistant)  
**å®¡æŸ¥æ—¥æœŸ**: 2026-02-07  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

