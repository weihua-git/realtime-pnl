# HTX 永续合约实时监控 - 使用指南

## 快速开始

### 1. 配置 API 密钥

```bash
# 复制配置文件
cp config.example.env .env

# 编辑 .env 文件，填入你的密钥
HTX_ACCESS_KEY=your_access_key
HTX_SECRET_KEY=your_secret_key
```

### 2. 选择运行模式

#### 模式 1：实时盈亏监控（推荐）⭐

```bash
node realtime-pnl.js
```

**显示内容：**
- ✅ 持仓数量（张数 + 实际币数）
- ✅ 持仓价值（USDT）
- ✅ 保证金（USDT）
- ✅ 最新价格 / 开仓价格
- ✅ 未实现盈亏（USDT）
- ✅ 收益率（%）
- ✅ 实时更新（每次价格变化都打印）

**输出示例：**
```
🔴 [11:59:04] ETH-USDT 空仓
   持仓: 21 张 × 0.01 = 0.2100 ETH
   持仓价值: 479.22 USDT | 保证金: 47.93 USDT
   最新价: 2282.00 | 开仓价: 2273.76
   未实现盈亏: -1.7304 USDT | 收益率: -3.61%
```

#### 模式 2：调试模式

```bash
node realtime-pnl-debug.js
```

**额外显示：**
- 连接状态详情
- 心跳发送/接收
- 消息统计
- 重连原因
- 延迟信息

#### 模式 3：基础监听

```bash
npm start
```

**功能：**
- 只监听持仓实际变化（开仓/平仓）
- 不显示实时价格变化

#### 模式 4：测试模式

```bash
node test-positions.js
```

**功能：**
- 理解 HTX 推送机制
- 统计推送次数

---

## 显示说明

### 持仓信息

| 字段 | 说明 | 示例 |
|------|------|------|
| 持仓 | 张数 × 合约面值 = 实际币数 | 21 张 × 0.01 = 0.2100 ETH |
| 持仓价值 | 实际币数 × 当前价格 | 0.21 × 2282 = 479.22 USDT |
| 保证金 | 占用的保证金 | 47.93 USDT |
| 最新价 | 当前市场价格 | 2282.00 |
| 开仓价 | 开仓时的均价 | 2273.76 |
| 未实现盈亏 | 当前浮动盈亏 | -1.7304 USDT |
| 收益率 | 盈亏 / 保证金 × 100% | -3.61% |

### 合约面值

| 合约 | 面值 | 说明 |
|------|------|------|
| BTC-USDT | 0.001 BTC/张 | 1 张 = 0.001 BTC |
| ETH-USDT | 0.01 ETH/张 | 1 张 = 0.01 ETH |
| 其他 | 1 USD/张 | 1 张 = 1 美元 |

### 计算公式

**持仓价值：**
```
持仓价值 = 持仓量 × 合约面值 × 当前价格
```

**未实现盈亏：**
```
多仓：(当前价 - 开仓价) × 持仓量 × 合约面值
空仓：(开仓价 - 当前价) × 持仓量 × 合约面值
```

**收益率：**
```
收益率 = (未实现盈亏 / 持仓保证金) × 100%
```

---

## 更新频率

### 实时模式（realtime-pnl.js）

- **价格更新：** 每秒 1-5 次（取决于市场波动）
- **持仓更新：** 仅在交易操作时
- **延迟：** 100-500ms

### 为什么每次都打印？

因为你要求"显示最新数据，每次变化都要打印"，所以：
- ✅ 每次收到新的行情数据就立即打印
- ✅ 没有延迟，实时显示
- ✅ 可以看到价格的每一次变化

如果觉得太频繁，可以添加节流（见下方优化）。

---

## 常见场景

### 场景 1：监控单个持仓

```bash
# 直接运行，自动监控所有持仓
node realtime-pnl.js
```

### 场景 2：监控多个持仓

程序会自动识别所有持仓并订阅对应的行情。

### 场景 3：查看为什么重连

```bash
# 使用调试模式
node realtime-pnl-debug.js
```

### 场景 4：验证计算是否正确

1. 运行程序查看计算结果
2. 登录 HTX 平台对比
3. 使用公式手动验证

---

## 优化建议

### 1. 减少打印频率（节流）

如果觉得更新太频繁，可以修改 `realtime-pnl.js`：

```javascript
// 在文件开头添加
let lastPrintTime = 0;
const printInterval = 1000; // 1秒打印一次

// 在 calculatePnL 函数开头添加
function calculatePnL(contractCode, lastPrice) {
  const now = Date.now();
  if (now - lastPrintTime < printInterval) {
    return; // 跳过这次打印
  }
  lastPrintTime = now;
  
  // ... 原有代码
}
```

### 2. 只显示盈亏变化

只在盈亏变化超过一定金额时打印：

```javascript
let lastProfit = {};

function calculatePnL(contractCode, lastPrice) {
  // ... 计算盈亏
  
  const key = `${contractCode}_${direction}`;
  const lastValue = lastProfit[key] || 0;
  
  // 只在盈亏变化超过 0.1 USDT 时打印
  if (Math.abs(profitUnreal - lastValue) < 0.1) {
    return;
  }
  
  lastProfit[key] = profitUnreal;
  
  // ... 打印信息
}
```

### 3. 添加盈亏提醒

```javascript
// 在打印后添加
if (profitRate > 10) {
  console.log('   🎉 盈利超过 10%，考虑止盈！');
}

if (profitRate < -5) {
  console.log('   ⚠️ 亏损超过 5%，注意风险！');
}
```

---

## 故障排查

### 问题 1：没有数据显示

**检查：**
1. 是否有持仓？
2. API 密钥是否正确？
3. 网络是否正常？

**解决：**
```bash
# 使用调试模式查看详情
node realtime-pnl-debug.js
```

### 问题 2：频繁重连

**原因：**
- 网络不稳定
- 防火墙阻断
- ISP 问题

**解决：**
1. 检查网络连接
2. 使用有线网络
3. 考虑使用 VPS

### 问题 3：计算结果不对

**检查：**
1. 合约面值是否正确？
2. 是否是特殊币种？
3. 对比 HTX 平台数据

**验证：**
```bash
# 使用调试模式查看详细计算
node realtime-pnl-debug.js
```

### 问题 4：延迟太高

**原因：**
- 网络延迟
- 服务器距离远

**解决：**
- 使用更快的网络
- 使用 VPS（香港/新加坡）

---

## 进阶使用

### 1. 记录到文件

```bash
# 将输出保存到文件
node realtime-pnl.js > pnl.log 2>&1

# 同时显示和保存
node realtime-pnl.js | tee pnl.log
```

### 2. 后台运行

```bash
# 使用 nohup
nohup node realtime-pnl.js > pnl.log 2>&1 &

# 使用 screen
screen -S htx
node realtime-pnl.js

# 使用 pm2
npm install -g pm2
pm2 start realtime-pnl.js --name htx-monitor
pm2 logs htx-monitor
```

### 3. 添加通知

可以集成：
- Telegram Bot
- 邮件通知
- 微信通知
- Webhook

---

## 总结

✅ **推荐使用：** `node realtime-pnl.js`
✅ **显示内容：** 持仓价值、盈亏、收益率
✅ **更新频率：** 实时（每次价格变化）
✅ **无延迟：** 立即显示最新数据

如有问题，查看：
- `README.md` - 完整文档
- `常见问题解答.md` - 问题解答
- `持仓监听说明.md` - 技术原理

祝交易顺利！🚀
