# 量化交易集成说明

## 功能介绍

量化交易功能已集成到 `realtime-pnl.js` 中，与持仓监控共享同一个 WebSocket 连接，无需额外启动进程。

## 核心特性

✅ **实时响应**：使用 WebSocket 实时行情，价格变化立即检查止盈止损
✅ **智能开仓**：基于技术指标（MA、RSI、MACD、布林带）自动判断交易信号
✅ **风险控制**：止损、止盈、移动止损三重保护
✅ **测试/实盘切换**：一键切换测试模式和实盘模式
✅ **资源共享**：复用现有 WebSocket 连接，无需额外进程

## 快速开始

### 1. 启用量化交易

编辑 `.env` 文件：

```bash
# 启用量化交易
QUANT_ENABLED=true

# 测试模式（默认）
QUANT_TEST_MODE=true

# 交易对
QUANT_SYMBOL=BTC-USDT

# 其他参数...
```

### 2. 启动程序

```bash
npm start
```

程序会自动加载量化交易模块，并在控制台显示：

```
🤖 量化交易模块初始化
   模式: 测试模式 (模拟交易)
   交易对: BTC-USDT
   初始资金: 1000.00 USDT
   杠杆: 5x
   仓位: 10%
   止损: 2% | 止盈: 5%
```

### 3. 查看状态

程序每 30 秒会自动打印量化交易状态：

```
════════════════════════════════════════════════════════════════════════════════
🤖 [量化交易] BTC-USDT - 测试模式
────────────────────────────────────────────────────────────────────────────────
💰 账户余额: 1050.23 USDT
💵 当前价格: 45230.50 USDT
📈 持仓数量: 1/1

持仓详情:
  持仓 #1 🟢
    方向: 做多 (LONG)
    开仓价: 45000.00 | 最新价: 45230.50
    保证金: 100.00 USDT | 杠杆: 5x
    🟢 收益: +2.56 USDT (ROE: +2.56%)

统计数据:
  总交易: 5 | 胜: 3 | 负: 2
  胜率: 60.00%
  🟢 总盈亏: +50.23 USDT (+5.02%)
  最大回撤: 1.23%
════════════════════════════════════════════════════════════════════════════════
```

## 配置参数说明

### 基础配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `QUANT_ENABLED` | 是否启用量化交易 | `false` |
| `QUANT_TEST_MODE` | 测试模式开关 | `true` |
| `QUANT_SYMBOL` | 交易对 | `BTC-USDT` |
| `QUANT_LEVERAGE` | 杠杆倍数 | `5` |
| `QUANT_INITIAL_BALANCE` | 测试模式初始资金 | `1000` |

### 仓位管理

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `QUANT_POSITION_SIZE` | 每次开仓比例 | `0.1` (10%) |
| `QUANT_MAX_POSITIONS` | 最大持仓数 | `1` |

### 风险控制

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `QUANT_STOP_LOSS` | 止损比例 | `0.02` (2%) |
| `QUANT_TAKE_PROFIT` | 止盈比例 | `0.05` (5%) |
| `QUANT_TRAILING_STOP` | 移动止损比例 | `0.03` (3%) |

## 交易策略

### 开仓条件

系统会综合以下技术指标判断开仓信号：

**做多信号（看涨）**：
- ✅ 多周期趋势向上
- ✅ 均线多头排列
- ✅ RSI 超卖反弹
- ✅ MACD 金叉
- ✅ 价格触及布林带下轨

**做空信号（看跌）**：
- ❌ 多周期趋势向下
- ❌ 均线空头排列
- ❌ RSI 超买回调
- ❌ MACD 死叉
- ❌ 价格触及布林带上轨

**信心指数 > 60** 才会开仓。

### 平仓条件

1. **止损**：亏损达到 2% 自动平仓
2. **止盈**：盈利达到 5% 自动平仓
3. **移动止损**：从最高/最低点回撤 3% 平仓

## 实时响应机制

### 价格更新流程

```
WebSocket 收到新价格
    ↓
立即检查持仓止盈止损（实时）
    ↓
每 30 秒检查一次交易信号（限流）
    ↓
符合条件则开仓/平仓
```

### 优势

- **无延迟**：价格变化立即触发检查
- **及时止损**：不会错过止盈止损时机
- **智能限流**：避免频繁调用 API
- **资源高效**：复用现有连接

## 切换到实盘模式

⚠️ **警告**：实盘模式会使用真实资金交易！

### 步骤

1. 确保在测试模式下验证策略有效性
2. 编辑 `.env` 文件：

```bash
# 切换到实盘模式
QUANT_TEST_MODE=false
```

3. 重启程序

### 注意事项

- 建议先用小额资金测试
- 确保网络连接稳定
- 定期检查程序运行状态
- 注意火币 API 调用频率限制

## 策略示例

### 保守策略

```bash
QUANT_LEVERAGE=3           # 低杠杆
QUANT_POSITION_SIZE=0.05   # 5% 仓位
QUANT_STOP_LOSS=0.015      # 1.5% 止损
QUANT_TAKE_PROFIT=0.03     # 3% 止盈
```

### 激进策略

```bash
QUANT_LEVERAGE=10          # 高杠杆
QUANT_POSITION_SIZE=0.2    # 20% 仓位
QUANT_STOP_LOSS=0.03       # 3% 止损
QUANT_TAKE_PROFIT=0.08     # 8% 止盈
```

### 多持仓策略

```bash
QUANT_MAX_POSITIONS=3      # 最多 3 个持仓
QUANT_POSITION_SIZE=0.1    # 每次 10%
```

## 日志说明

### 开仓日志

```
📈 [量化] 检测到做多信号 (信心: 75%)
✅ [量化] 模拟开仓: LONG 0.0011 @ 45000.00
   保证金: 100.00 USDT | 杠杆: 5x
```

### 平仓日志

```
🎯 [量化] 触发止盈: LONG @ 47250.00 (盈利 5.00%)
✅ [量化] 模拟平仓: LONG @ 47250.00
   盈亏: +24.75 USDT (+5.00%)
   原因: 止盈
```

### 状态日志

每 30 秒自动打印，包含：
- 账户余额
- 当前价格
- 持仓详情（方向、价格、盈亏、ROE）
- 统计数据（总交易、胜率、总盈亏、最大回撤）

## 常见问题

### Q1: 如何关闭量化交易？

编辑 `.env` 文件，设置 `QUANT_ENABLED=false`，然后重启程序。

### Q2: 可以同时监控多个交易对吗？

目前每个实例只支持一个交易对。如需监控多个，可以启动多个进程。

### Q3: 测试模式和实盘模式有什么区别？

- **测试模式**：使用模拟资金，不会真实下单
- **实盘模式**：连接火币 API，使用真实资金交易

### Q4: 为什么没有开仓？

可能原因：
- 信心指数 < 60（信号不够强）
- 已达到最大持仓数
- 市场趋势不明确

### Q5: 如何调整策略更激进/保守？

- **更激进**：提高杠杆、增加仓位、放宽止损
- **更保守**：降低杠杆、减少仓位、收紧止损

### Q6: 会影响现有的持仓监控功能吗？

不会。量化交易是独立模块，与持仓监控并行运行，互不影响。

## 优势对比

### 集成方案 vs 独立进程

| 特性 | 集成方案 | 独立进程 |
|------|---------|---------|
| WebSocket 连接 | 共享 1 个 | 需要 2 个 |
| 资源占用 | 低 | 高 |
| 启动命令 | 1 个 | 2 个 |
| 配置管理 | 统一 | 分散 |
| 实时性 | 高 | 高 |

## 技术支持

如有问题，请查看：
- [快速开始](./快速开始.md)
- [常见问题解答](./常见问题解答.md)
- [量化交易使用指南](./量化交易使用指南.md)
