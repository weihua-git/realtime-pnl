# 量化交易架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户配置 (.env)                          │
│                                                                 │
│  QUANT_TEST_MODE=true/false  ← 控制模式切换                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      QuantTrader 模块                            │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  构造函数：根据 testMode 设置 Redis 键名                  │  │
│  │  this.redisKey = `quant:${test/live}:${symbol}`          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                              │                                  │
│              ┌───────────────┴───────────────┐                  │
│              ▼                               ▼                  │
│    ┌──────────────────┐          ┌──────────────────┐          │
│    │   测试模式路径    │          │   实盘模式路径    │          │
│    │   🧪 Test Mode   │          │   🔴 Live Mode   │          │
│    └──────────────────┘          └──────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
              │                               │
              ▼                               ▼
```

## 测试模式数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                      🧪 测试模式 (Test Mode)                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   1. 启动时加载状态            │
              │   loadState()                 │
              │   ✅ 从 Redis 读取            │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   2. 验证持仓（如有）          │
              │   verifyPositionsOnStartup()  │
              │   ✅ 检查止盈止损              │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   3. 模拟交易                  │
              │   - 开仓/平仓                  │
              │   - 计算盈亏                   │
              │   - 扣除手续费                 │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   4. 保存状态                  │
              │   saveState()                 │
              │   ✅ 写入 Redis               │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   Redis 存储                   │
              │   htx:cache:quant:test:BTC    │
              │   {                           │
              │     balance: 1050.23,         │
              │     positions: [...],         │
              │     stats: {...}              │
              │   }                           │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   5. 支持重置                  │
              │   resetState()                │
              │   ✅ 删除 Redis 键            │
              │   ✅ 恢复初始状态              │
              └───────────────────────────────┘
```

## 实盘模式数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                      🔴 实盘模式 (Live Mode)                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   1. 启动时不加载 Redis        │
              │   loadState()                 │
              │   ❌ 直接返回                  │
              │   📝 日志：从 API 获取数据     │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   2. 不验证持仓                │
              │   verifyPositionsOnStartup()  │
              │   ❌ 跳过                      │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   3. 真实交易                  │
              │   - 调用火币 API               │
              │   - 真实开仓/平仓              │
              │   - 真实手续费                 │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   4. 不保存到 Redis            │
              │   saveState()                 │
              │   ❌ 直接返回                  │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   火币 API                     │
              │   - 获取真实余额               │
              │   - 获取真实持仓               │
              │   - 获取真实订单               │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   5. 不支持重置                │
              │   resetState()                │
              │   ❌ 返回 false                │
              │   📝 日志：实盘不允许重置      │
              └───────────────────────────────┘
```

## Redis 键名隔离

```
Redis DB 3
│
├── htx:cache:quant:test:BTC-USDT     ← 测试模式 BTC
│   └── {
│         "balance": 1050.23,
│         "positions": [...],
│         "orders": [...],
│         "stats": {...}
│       }
│
├── htx:cache:quant:test:ETH-USDT     ← 测试模式 ETH
│   └── { ... }
│
├── htx:cache:quant:live:BTC-USDT     ← 实盘模式 BTC（不会创建）
│   └── (empty)
│
└── htx:cache:quant:live:ETH-USDT     ← 实盘模式 ETH（不会创建）
    └── (empty)

注意：实盘模式不会创建 Redis 键，因为 saveState() 会直接返回
```

## Web API 隔离

```
┌─────────────────────────────────────────────────────────────────┐
│                    POST /api/quant/reset                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   检查模式                     │
              │   QUANT_TEST_MODE === 'true'? │
              └───────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                ▼                           ▼
    ┌──────────────────┐        ┌──────────────────┐
    │   测试模式        │        │   实盘模式        │
    │   ✅ 允许重置     │        │   ❌ 拒绝重置     │
    └──────────────────┘        └──────────────────┘
                │                           │
                ▼                           ▼
    ┌──────────────────┐        ┌──────────────────┐
    │ 删除 Redis 键     │        │ 返回 403 错误     │
    │ quant:test:*     │        │ "实盘不允许重置"  │
    └──────────────────┘        └──────────────────┘
                │                           │
                ▼                           ▼
    ┌──────────────────┐        ┌──────────────────┐
    │ 返回成功          │        │ 用户看到错误      │
    │ {success: true}  │        │ {error: "..."}   │
    └──────────────────┘        └──────────────────┘
```

## 模式切换流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         初始状态                                 │
│                    测试模式运行中                                │
│                    有余额、持仓、统计                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   1. 停止程序                  │
              │   Ctrl+C                      │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   2. 修改 .env                 │
              │   QUANT_TEST_MODE=false       │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   3. 重启程序                  │
              │   node realtime-pnl.js        │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   4. 实盘模式启动              │
              │   🔴 实盘模式                  │
              │   ❌ 不加载测试数据            │
              │   ✅ 从 API 获取真实数据       │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   5. 测试数据保持不变          │
              │   Redis 中的测试数据依然存在   │
              │   quant:test:BTC-USDT         │
              └───────────────────────────────┘
                              │
                              ▼
              ┌───────────────────────────────┐
              │   6. 切换回测试模式            │
              │   QUANT_TEST_MODE=true        │
              │   ✅ 恢复之前的测试状态        │
              └───────────────────────────────┘
```

## 安全保护层级

```
┌─────────────────────────────────────────────────────────────────┐
│                         第 1 层：环境变量                         │
│                    QUANT_TEST_MODE=true/false                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         第 2 层：配置对象                         │
│                    this.config.testMode                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         第 3 层：Redis 键名                       │
│                    quant:test:* vs quant:live:*                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         第 4 层：方法检查                         │
│         loadState(), saveState(), resetState() 检查模式         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         第 5 层：API 保护                         │
│                    /api/quant/reset 检查模式                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         第 6 层：日志警告                         │
│                    🔴 实盘模式警告提示                           │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流对比

### 测试模式

```
价格更新 → 检查信号 → 模拟开仓 → 保存 Redis → 检查止盈止损 → 模拟平仓 → 保存 Redis
   ↓                                                                    ↓
实时价格                                                            更新统计
   ↓                                                                    ↓
技术指标                                                            Web 界面
```

### 实盘模式

```
价格更新 → 检查信号 → 调用 API → 真实开仓 → 检查止盈止损 → 调用 API → 真实平仓
   ↓                      ↓                                    ↓
实时价格              火币 API                              火币 API
   ↓                      ↓                                    ↓
技术指标              真实订单                              真实订单
                          ↓                                    ↓
                      真实手续费                            真实盈亏
```

## 总结

```
┌─────────────────────────────────────────────────────────────────┐
│                         核心原则                                 │
│                                                                 │
│  1. 测试和实盘完全隔离，互不影响                                │
│  2. Redis 只用于测试模式，实盘从 API 获取                       │
│  3. 实盘模式不允许重置，防止误操作                              │
│  4. 多层保护，确保安全可靠                                      │
│  5. 日志清晰，模式标识明确                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
