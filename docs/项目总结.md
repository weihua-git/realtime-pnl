# HTX 永续合约监控系统 - 项目总结

## 🎉 已完成功能

### 1. 核心监控功能
- ✅ 实时持仓盈亏监控
- ✅ 市场行情趋势监控
- ✅ 自动订阅管理（开仓自动订阅，平仓自动取消）
- ✅ WebSocket 自动重连
- ✅ 多合约支持

### 2. 通知系统
- ✅ **Bark 通知**（iOS 专用，延迟 < 1秒）
  - 盈利通知：paymentsuccess 音效
  - 亏损通知：alarm 音效
  - 行情推送：静默通知
- ✅ **Telegram 通知**（跨平台，延迟 3-15秒）
- ✅ **统一通知器**（支持同时使用两种通知）
- ✅ 智能通知触发（百分比 + 绝对金额）
- ✅ 防重复通知机制

### 3. 配置和管理
- ✅ 环境变量配置（.env）
- ✅ 市场监控配置（market-config.js）
- ✅ 多时间窗口监控
- ✅ 可自定义通知阈值

### 4. 测试和工具
- ✅ Bark 通知测试
- ✅ Telegram 通知测试
- ✅ 统一通知器测试
- ✅ 音效测试
- ✅ 配置检查工具
- ✅ 快速测试脚本

### 5. 文档
- ✅ README.md - 项目说明
- ✅ Bark配置指南.md - Bark 详细配置
- ✅ Bark快速上手.md - 3分钟快速配置
- ✅ Telegram配置指南.md - Telegram 配置
- ✅ 通知对比.md - 两种通知方式对比
- ✅ 部署指南.md - 生产环境部署
- ✅ 常见问题解答.md
- ✅ 更新说明.md

---

## 📁 项目结构

```
htx-monitor/
├── 核心文件
│   ├── realtime-pnl.js          # 主程序（持仓+行情监控）
│   ├── client.js                # HTX WebSocket 客户端
│   ├── auth.js                  # API 认证
│   ├── market-config.js         # 市场监控配置
│   └── index.js                 # 旧版基础监听
│
├── 通知系统
│   ├── bark-notifier.js         # Bark 通知器
│   ├── telegram-notifier.js     # Telegram 通知器
│   └── unified-notifier.js      # 统一通知器
│
├── 测试脚本
│   ├── test-bark.js             # Bark 测试
│   ├── test-telegram.js         # Telegram 测试
│   ├── test-unified.js          # 统一通知器测试
│   ├── test-sound.js            # 音效测试
│   ├── test-positions.js        # 持仓数据测试
│   ├── quick-test.js            # 快速配置测试
│   └── check-config.js          # 配置检查
│
├── 配置文件
│   ├── .env                     # 环境变量（需自行创建）
│   ├── config.example.env       # 配置模板
│   └── package.json             # 项目配置
│
└── 文档
    ├── README.md
    ├── Bark配置指南.md
    ├── Bark快速上手.md
    ├── Telegram配置指南.md
    ├── 通知对比.md
    ├── 部署指南.md
    ├── 项目总结.md
    └── 其他文档...
```

---

## 🚀 快速开始

### 1. 安装依赖
```bash
npm install
```

### 2. 配置
```bash
cp config.example.env .env
# 编辑 .env，填入配置
```

### 3. 检查
```bash
npm run build
```

### 4. 测试通知
```bash
npm run test:bark
```

### 5. 启动
```bash
npm start
```

---

## 📱 通知配置

### 推荐配置（仅 Bark）

```env
# .env
HTX_ACCESS_KEY=你的Key
HTX_SECRET_KEY=你的Secret
BARK_KEY=你的BarkKey
```

**优势**：
- 延迟 < 1 秒
- 配置简单
- 完全免费

### 双通知配置

```env
# .env
HTX_ACCESS_KEY=你的Key
HTX_SECRET_KEY=你的Secret
BARK_KEY=你的BarkKey
TELEGRAM_BOT_TOKEN=你的Token
TELEGRAM_CHAT_ID=你的ChatID
```

**优势**：
- Bark 提供实时通知
- Telegram 提供历史记录
- 互为备份

---

## 🎵 音效配置

当前配置：
- **盈利通知**: `paymentsuccess`（欢快）
- **亏损通知**: `alarm`（警报）
- **行情推送**: 无音效（静默）

测试音效：
```bash
npm run test:sound
```

---

## 📊 通知触发条件

### 持仓盈亏通知

**触发条件**（满足任一即可）：
- 盈利达到 3% 或 2 USDT
- 亏损达到 -5% 或 -2 USDT
- 持续上涨/下跌每变化 1%

**防重复**：
- 同一持仓 5 秒内不重复通知

### 行情推送通知

**触发条件**（多时间窗口）：
- 5分钟内变化 1% 或 50 USDT
- 15分钟内变化 2% 或 100 USDT
- 1小时内变化 3% 或 200 USDT

**防重复**：
- 同一合约 5 分钟内不重复通知

### 定时汇总

- 每 1 小时发送持仓汇总

---

## 🛠️ 可用命令

### 运行
```bash
npm start              # 启动监控
npm run dev            # 开发模式（自动重启）
```

### 测试
```bash
npm run test           # 测试所有通知
npm run test:bark      # 测试 Bark
npm run test:telegram  # 测试 Telegram
npm run test:sound     # 测试音效
```

### 构建
```bash
npm run build          # 完整检查
npm run check          # 配置检查
```

---

## 🔧 自定义配置

### 修改通知阈值

编辑 `realtime-pnl.js`：

```javascript
notificationConfig: {
  profitThreshold: 3,           // 盈利 3% 时通知
  lossThreshold: -5,            // 亏损 5% 时通知
  profitAmountThreshold: 2,     // 盈利 2 USDT 时通知
  lossAmountThreshold: -2,      // 亏损 2 USDT 时通知
  timeInterval: 3600000,        // 1 小时定时通知
  repeatInterval: 5000,         // 5 秒防重复
}
```

### 修改监控合约

编辑 `market-config.js`：

```javascript
watchContracts: [
  'BTC-USDT',
  'ETH-USDT',
  'SOL-USDT',
  // 添加更多...
]
```

### 修改音效

编辑 `bark-notifier.js`：

```javascript
// 盈利通知音效
sound: 'paymentsuccess'

// 亏损通知音效
sound: 'alarm'
```

可用音效：alarm, bell, glass, horn, minuet, paymentsuccess 等

---

## 📈 性能指标

- **内存占用**: ~50-100MB
- **CPU 占用**: < 5%
- **网络流量**: ~1-5MB/小时
- **通知延迟**: 
  - Bark: < 1 秒
  - Telegram: 3-15 秒

---

## 🔒 安全建议

1. **保护 API 密钥**
   ```bash
   chmod 600 .env
   ```

2. **不要提交敏感信息**
   ```bash
   echo ".env" >> .gitignore
   ```

3. **使用只读 API 权限**
   - HTX API 只需要"读取"权限
   - 不需要"交易"权限

4. **定期更新依赖**
   ```bash
   npm update
   ```

---

## 🐛 故障排查

### 连接失败
```bash
# 检查网络
ping api.hbdm.com

# 测试配置
npm run check
```

### 通知不工作
```bash
# 测试 Bark
npm run test:bark

# 检查配置
cat .env | grep BARK_KEY
```

### 内存泄漏
```bash
# 使用 PM2 监控
pm2 monit

# 设置自动重启
pm2 start realtime-pnl.js --max-memory-restart 500M
```

---

## 📚 相关文档

- [Bark 官方文档](https://github.com/Finb/Bark)
- [HTX API 文档](https://www.htx.com/zh-cn/opend/newApiPages/)
- [Telegram Bot API](https://core.telegram.org/bots/api)

---

## 🎯 下一步计划

可能的功能扩展：
- [ ] Web 控制面板
- [ ] 历史数据记录
- [ ] 策略回测
- [ ] 多账户支持
- [ ] 更多通知渠道（钉钉、企业微信等）
- [ ] 风险控制提醒
- [ ] 自动止盈止损建议

---

## 💡 使用建议

### 日内交易者
- 使用 Bark（低延迟）
- 设置较小的通知阈值（1-2%）
- 关注行情推送

### 长期持仓者
- 使用 Telegram（历史记录）
- 设置较大的通知阈值（5-10%）
- 关注定时汇总

### 专业交易者
- 同时使用 Bark + Telegram
- 自定义多个阈值
- 监控多个合约

---

## ✅ 项目特点

1. **低延迟通知** - Bark < 1秒
2. **智能触发** - 百分比 + 金额双重阈值
3. **防重复** - 避免通知轰炸
4. **自动管理** - 订阅自动跟随持仓
5. **灵活配置** - 所有参数可调
6. **完善文档** - 详细的配置和使用说明
7. **易于部署** - 一键检查和启动
8. **稳定可靠** - 自动重连机制

---

## 🙏 致谢

- HTX (Huobi) - API 支持
- Bark - iOS 推送服务
- Telegram - 跨平台通知

---

**项目已完成，可以正常使用！** 🎉

如有问题，请查看相关文档或提交 Issue。
