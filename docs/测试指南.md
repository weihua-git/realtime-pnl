# 量化交易功能测试指南

## 📋 测试概述

本项目提供了三种测试方式，从简单到复杂，帮助你验证量化交易功能是否正常工作。

## 🚀 快速开始

### 1. 快速环境检查（推荐首先运行）

```bash
bash quick-test.sh
```

**测试内容：**
- ✅ Node.js 和 Redis 环境检查
- ✅ 配置文件完整性检查
- ✅ JavaScript 语法检查
- ✅ HTML 结构验证
- ✅ Redis 数据结构检查
- ✅ NPM 依赖包检查

**预期结果：**
```
🎉 所有测试通过！可以启动程序了

启动命令:
  node realtime-pnl.js    # 启动监控程序
  node web-server.js      # 启动 Web 服务器
```

---

### 2. API 端点测试（需要先启动服务）

**步骤 1：启动服务**
```bash
# 终端 1：启动监控程序
node realtime-pnl.js

# 终端 2：启动 Web 服务器
node web-server.js
```

**步骤 2：运行 API 测试**
```bash
# 终端 3：运行测试
bash test-api.sh
```

**测试内容：**
- ✅ 配置 API（GET/POST /api/config）
- ✅ 市场分析 API（GET /api/analysis/:symbol）
- ✅ 量化交易 API（GET/POST /api/quant/*）
- ✅ WebSocket 连接测试

**预期结果：**
```
🎉 所有 API 测试通过！
```

---

### 3. 完整功能测试（深度测试）

```bash
node test-quant-trading.js
```

**测试内容：**
- ✅ 初始化和配置加载
- ✅ 状态管理（Redis 保存/加载/重置）
- ✅ 开仓逻辑验证
- ✅ 止盈止损计算
- ✅ 盈亏计算（火币公式）
- ✅ 平仓逻辑验证
- ✅ 历史订单记录
- ✅ 重置功能
- ✅ 停止功能（持仓检查）
- ✅ 状态获取

**预期结果：**
```
🎉 所有测试通过！

总测试数: 30+
通过: 30+
失败: 0
通过率: 100.00%
```

---

## 🔍 手动测试流程

### 测试 1：基础功能测试

1. **启动程序**
   ```bash
   node realtime-pnl.js
   ```

2. **检查日志输出**
   - 应该看到 "🤖 量化交易系统已启动"
   - 应该看到 "🧪 测试模式 (模拟交易)"
   - 应该看到 "💰 初始余额: 1000.00 USDT"

3. **打开 Web 界面**
   ```bash
   # 另一个终端
   node web-server.js
   ```
   
   访问: http://localhost:3000
   
   - 应该默认显示"智能交易"页面
   - 应该看到实时数据更新
   - WebSocket 状态应该显示"已连接"

### 测试 2：开仓测试

1. **等待信号**
   - 观察"信号历史"区域
   - 等待出现"做多"或"做空"信号
   - 信心指数应该 ≥ 配置的最小信心值

2. **验证开仓**
   - 应该在"当前持仓"看到新持仓
   - 余额应该减少（扣除保证金和手续费）
   - 持仓应该显示：
     - 开仓价格
     - 保证金
     - 收益率（ROE）
     - 止损价/止盈价

### 测试 3：平仓测试

1. **等待平仓条件**
   - 价格触及止损价
   - 价格触及止盈价
   - 或者移动止损触发

2. **验证平仓**
   - 持仓应该消失
   - 余额应该更新
   - 统计数据应该更新（总交易、盈利/亏损次数）
   - 历史订单应该增加一条记录

### 测试 4：重置功能测试

1. **点击"重新开始"按钮**
   - 应该弹出确认对话框
   - 确认后余额应该恢复到初始值
   - 所有统计数据应该清零
   - 历史订单应该清空

### 测试 5：停止功能测试

1. **无持仓时停止**
   - 点击"停止"按钮
   - 应该成功停止

2. **有持仓时停止**
   - 先开仓
   - 点击"停止"按钮
   - 应该提示"有持仓时无法停止"

---

## 🐛 常见问题排查

### 问题 1：Redis 连接失败

**症状：**
```
❌ Redis 连接失败
```

**解决方案：**
```bash
# 启动 Redis
redis-server

# 或者使用 Homebrew (macOS)
brew services start redis
```

### 问题 2：WebSocket 连接失败

**症状：**
- Web 界面显示"未连接"
- 数据不更新

**解决方案：**
1. 确保 `realtime-pnl.js` 正在运行
2. 检查端口 3000 是否被占用
3. 刷新浏览器页面

### 问题 3：量化交易未启动

**症状：**
- 看不到"智能交易系统"卡片
- 或显示"智能交易未启用"

**解决方案：**
检查 `.env` 配置：
```bash
QUANT_ENABLED=true
QUANT_TEST_MODE=true
```

### 问题 4：没有交易信号

**症状：**
- 长时间没有开仓
- 信号历史为空

**可能原因：**
1. 信心指数不足（< 最小信心值）
2. 已达到最大持仓数
3. 余额不足

**解决方案：**
- 降低 `QUANT_MIN_CONFIDENCE`
- 增加 `QUANT_MAX_POSITIONS`
- 检查余额是否充足

---

## 📊 测试数据说明

### 测试模式 vs 实盘模式

| 特性 | 测试模式 | 实盘模式 |
|------|---------|---------|
| 资金 | 模拟资金 | 真实资金 |
| 交易 | 模拟交易 | 真实交易 |
| 数据存储 | Redis | Redis + API |
| 持仓数据 | Redis | WebSocket 实时 |
| 风险 | 无风险 | 有风险 ⚠️ |

### 推荐测试配置

```env
# 测试模式配置（安全）
QUANT_ENABLED=true
QUANT_TEST_MODE=true
QUANT_SYMBOL=BTC-USDT
QUANT_LEVERAGE=10
QUANT_INITIAL_BALANCE=1000
QUANT_POSITION_SIZE=0.1
QUANT_STOP_LOSS=0.02
QUANT_TAKE_PROFIT=0.05
QUANT_TRAILING_STOP=0.03
QUANT_MAX_POSITIONS=1
QUANT_MIN_CONFIDENCE=60
```

---

## 🎯 测试检查清单

### 启动前检查
- [ ] Redis 已启动
- [ ] `.env` 配置正确
- [ ] `npm install` 已完成
- [ ] 测试模式已启用

### 功能测试
- [ ] 程序正常启动
- [ ] Web 界面可访问
- [ ] WebSocket 连接成功
- [ ] 实时价格更新
- [ ] 信号生成正常
- [ ] 开仓功能正常
- [ ] 平仓功能正常
- [ ] 止盈止损计算正确
- [ ] 历史订单记录正常
- [ ] 重置功能正常
- [ ] 停止功能正常

### 数据验证
- [ ] 余额计算正确
- [ ] 盈亏计算正确（火币公式）
- [ ] ROE 计算正确
- [ ] 手续费扣除正确
- [ ] 统计数据准确

---

## 📝 测试报告模板

```markdown
## 测试报告

**测试日期：** 2024-XX-XX
**测试人员：** XXX
**测试环境：** 测试模式

### 测试结果

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 环境检查 | ✅ | - |
| 程序启动 | ✅ | - |
| Web 界面 | ✅ | - |
| 开仓功能 | ✅ | - |
| 平仓功能 | ✅ | - |
| 盈亏计算 | ✅ | - |
| 历史订单 | ✅ | - |
| 重置功能 | ✅ | - |
| 停止功能 | ✅ | - |

### 发现的问题

1. 无

### 建议

1. 测试通过，可以进入实盘测试
2. 建议先用小资金测试

### 总结

所有功能测试通过，系统运行稳定。
```

---

## 🚨 实盘测试注意事项

⚠️ **在切换到实盘模式前，请务必：**

1. ✅ 完成所有测试模式测试
2. ✅ 验证盈亏计算准确性
3. ✅ 理解所有配置参数
4. ✅ 设置合理的止损止盈
5. ✅ 从小资金开始测试
6. ✅ 密切监控前几笔交易
7. ✅ 准备好随时手动干预

**实盘配置建议：**
```env
QUANT_TEST_MODE=false  # 切换到实盘
QUANT_LEVERAGE=5       # 降低杠杆
QUANT_POSITION_SIZE=0.05  # 降低仓位
QUANT_STOP_LOSS=0.03   # 放宽止损
QUANT_MAX_POSITIONS=1  # 限制持仓数
```

---

## 📞 获取帮助

如果测试过程中遇到问题：

1. 查看日志输出
2. 检查 Redis 数据：`redis-cli keys "quant:*"`
3. 查看配置文件：`.env`
4. 参考文档：`docs/` 目录

---

**祝测试顺利！** 🎉
