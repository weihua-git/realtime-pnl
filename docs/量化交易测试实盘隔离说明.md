# 量化交易测试/实盘模式隔离说明

## 概述

量化交易模块支持**测试模式**和**实盘模式**，两种模式完全隔离，互不影响。

## 模式切换

在 `.env` 文件中配置：

```env
# 测试模式（模拟交易，不使用真实资金）
QUANT_TEST_MODE=true

# 实盘模式（真实交易，使用真实资金）⚠️
QUANT_TEST_MODE=false
```

## 隔离机制

### 1. Redis 键名隔离

测试模式和实盘模式使用不同的 Redis 键名前缀：

- **测试模式**: `htx:cache:quant:test:BTC-USDT`
- **实盘模式**: `htx:cache:quant:live:BTC-USDT`

这确保了两种模式的数据完全独立存储，不会互相覆盖。

### 2. 状态持久化隔离

| 功能 | 测试模式 | 实盘模式 |
|------|---------|---------|
| 状态保存到 Redis | ✅ 自动保存 | ❌ 不保存 |
| 从 Redis 加载状态 | ✅ 自动加载 | ❌ 不加载 |
| 重启后恢复状态 | ✅ 恢复余额、持仓、统计 | ❌ 从 API 获取真实数据 |
| 持仓验证 | ✅ 验证离线期间止盈止损 | ❌ 不验证（使用 API 真实持仓） |

### 3. 功能限制

| 功能 | 测试模式 | 实盘模式 |
|------|---------|---------|
| 重置状态 | ✅ 允许 | ❌ 禁止 |
| 模拟交易 | ✅ 是 | ❌ 否 |
| 调用火币 API | ❌ 否 | ✅ 是 |
| 手续费扣除 | ✅ 模拟扣除 | ✅ 真实扣除 |

### 4. 日志标识

所有日志都会明确标注当前模式：

```
🧪 测试模式 (模拟交易)
🔴 实盘模式 (真实交易)
```

## 使用示例

### 测试模式（推荐先使用）

1. 设置 `.env`:
   ```env
   QUANT_TEST_MODE=true
   QUANT_INITIAL_BALANCE=1000
   ```

2. 启动监控程序：
   ```bash
   node realtime-pnl.js
   ```

3. 查看日志：
   ```
   🤖 量化交易模块初始化
      状态: ✅ 已启用
      模式: 🧪 测试模式 (模拟交易)
      交易对: BTC-USDT
      测试资金: 1000.00 USDT
   ```

4. 重置状态（仅测试模式）：
   - 在 Web 界面点击 "🔄 重新开始" 按钮
   - 或调用 API: `POST /api/quant/reset`

### 实盘模式（谨慎使用）⚠️

1. 设置 `.env`:
   ```env
   QUANT_TEST_MODE=false
   HTX_ACCESS_KEY=你的API密钥
   HTX_SECRET_KEY=你的API密钥
   ```

2. 启动监控程序：
   ```bash
   node realtime-pnl.js
   ```

3. 查看日志：
   ```
   🤖 量化交易模块初始化
      状态: ✅ 已启用
      模式: 🔴 实盘模式 (真实交易)
      交易对: BTC-USDT
      实盘资金: 从 API 获取
   
   🔴 警告: 实盘模式已启用，将使用真实资金交易！
   ```

## 安全保护

### 1. 实盘模式保护

- ❌ **不允许重置状态**：防止误操作清空真实交易记录
- ❌ **不保存到 Redis**：避免模拟数据覆盖真实数据
- ✅ **从 API 获取真实数据**：确保数据准确性

### 2. 测试模式保护

- ✅ **允许重置状态**：方便测试不同策略
- ✅ **状态持久化**：重启后恢复测试进度
- ✅ **离线持仓验证**：模拟真实场景

## 切换模式注意事项

1. **切换前停止程序**：避免数据混乱
2. **检查 Redis 键名**：确认使用正确的键前缀
3. **验证配置**：确认 `.env` 中的 `QUANT_TEST_MODE` 设置正确
4. **查看启动日志**：确认模式标识正确

## Redis 键名查看

使用 Redis CLI 查看当前存储的数据：

```bash
# 连接 Redis
redis-cli -n 3

# 查看所有量化交易键
KEYS htx:cache:quant:*

# 查看测试模式数据
GET htx:cache:quant:test:BTC-USDT

# 查看实盘模式数据（应该为空）
GET htx:cache:quant:live:BTC-USDT

# 删除测试数据（等同于重置）
DEL htx:cache:quant:test:BTC-USDT
```

## 常见问题

### Q: 切换模式后数据会丢失吗？

A: 不会。测试模式和实盘模式的数据完全独立：
- 测试模式数据存储在 `quant:test:*`
- 实盘模式数据存储在 `quant:live:*`（但实盘模式不使用 Redis）

### Q: 如何确认当前是哪种模式？

A: 查看启动日志中的模式标识：
- 🧪 = 测试模式
- 🔴 = 实盘模式

### Q: 实盘模式为什么不保存到 Redis？

A: 实盘模式的数据应该从火币 API 获取，确保数据准确性。Redis 只用于测试模式的状态持久化。

### Q: 测试模式的数据准确吗？

A: 测试模式使用真实的市场价格和技术指标，但交易是模拟的。手续费、滑点等都会模拟，但可能与实盘有细微差异。

## 总结

- ✅ **测试模式**：适合策略测试、参数调优，数据持久化到 Redis
- ✅ **实盘模式**：真实交易，从 API 获取数据，不使用 Redis
- ✅ **完全隔离**：两种模式互不影响，可以安全切换
- ⚠️ **谨慎使用实盘**：确保充分测试后再启用实盘模式
