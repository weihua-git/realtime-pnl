# HTX 持仓监听说明

## 问题：为什么 `positions` 只推送一次？

这是 **HTX 的正常设计**，不是 bug！

### HTX 持仓推送机制

✅ **会触发推送的情况：**
- 开仓（新建持仓）
- 平仓（减少持仓）
- 加仓（增加持仓）
- 调整保证金
- 强平

❌ **不会触发推送的情况：**
- 价格变化（即使盈亏在变化）
- 持仓量不变
- 只是查看持仓

## 解决方案

### 方案 1：实时盈亏监控（推荐）✨

使用 `realtime-pnl.js` 脚本，自动订阅市场行情并计算实时盈亏：

```bash
node realtime-pnl.js
```

**功能：**
- ✅ 实时显示持仓盈亏（随价格变化）
- ✅ 自动订阅持仓合约的行情
- ✅ 每秒更新盈亏数据
- ✅ 显示收益率百分比

**输出示例：**
```
🔴 [11:49:21] ETH-USDT 空仓
   最新价: 2279.87 | 开仓价: 2273.76 | 持仓量: 21
   未实现盈亏: -128.3100 USDT | 收益率: -2.68%
```

### 方案 2：基础监听

使用 `index.js`，只监听持仓实际变化：

```bash
npm start
```

**功能：**
- ✅ 监听订单变化
- ✅ 监听持仓变化（仅在交易操作时）
- ✅ 监听账户余额变化
- ✅ 监听成交订单

### 方案 3：测试脚本

使用 `test-positions.js` 了解推送机制：

```bash
node test-positions.js
```

**功能：**
- ✅ 详细说明推送机制
- ✅ 统计推送次数
- ✅ 帮助理解 HTX 行为

## 技术原理

### 为什么需要两个 WebSocket？

1. **私有频道 WebSocket**（需要认证）
   - 地址：`wss://api.hbdm.com/linear-swap-notification`
   - 用途：订单、持仓、账户等私有数据
   - 推送：仅在数据实际变化时

2. **市场行情 WebSocket**（无需认证）
   - 地址：`wss://api.hbdm.com/linear-swap-ws`
   - 用途：价格、深度、K线等公共数据
   - 推送：实时推送（每秒多次）

### 实时盈亏计算公式

**多仓盈亏：**
```
未实现盈亏 = (当前价 - 开仓价) × 持仓量
```

**空仓盈亏：**
```
未实现盈亏 = (开仓价 - 当前价) × 持仓量
```

**收益率：**
```
收益率 = (未实现盈亏 / 持仓保证金) × 100%
```

## 常见问题

### Q1: 为什么实时盈亏和 HTX 平台显示的不一样？

A: 可能的原因：
- 网络延迟（行情推送有延迟）
- 手续费未计入
- 资金费率未计入
- 平台显示的是综合盈亏

### Q2: 可以同时运行多个脚本吗？

A: 可以，但建议：
- 只运行一个实时监控脚本
- 避免重复订阅相同频道
- 注意 API 连接数限制

### Q3: 如何监听特定合约？

A: 修改 `realtime-pnl.js` 中的持仓订阅：

```javascript
// 监听所有合约
client.subscribePositions('*');

// 或只监听特定合约
client.subscribePositions('BTC-USDT');
client.subscribePositions('ETH-USDT');
```

### Q4: 行情更新频率是多少？

A: HTX 市场行情推送频率：
- 正常情况：每秒 1-5 次
- 波动大时：更频繁
- 可以通过节流控制显示频率

## 进阶优化

### 添加节流控制

如果觉得更新太频繁，可以添加节流：

```javascript
let lastUpdate = 0;
const throttleMs = 1000; // 1秒更新一次

function calculatePnL(contractCode, lastPrice) {
  const now = Date.now();
  if (now - lastUpdate < throttleMs) return;
  lastUpdate = now;
  
  // ... 原有计算逻辑
}
```

### 添加盈亏提醒

```javascript
function calculatePnL(contractCode, lastPrice) {
  // ... 计算盈亏
  
  // 盈利超过 10% 提醒
  if (profitRate > 10) {
    console.log('🎉 盈利超过 10%，考虑止盈！');
  }
  
  // 亏损超过 5% 警告
  if (profitRate < -5) {
    console.log('⚠️ 亏损超过 5%，注意风险！');
  }
}
```

## 总结

- ✅ `positions` 只在持仓变化时推送是正常的
- ✅ 使用 `realtime-pnl.js` 可以实时监控盈亏
- ✅ 需要同时连接私有频道和市场行情
- ✅ 自己计算盈亏更灵活可控

祝交易顺利！🚀
