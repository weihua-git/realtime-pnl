# 智能通知机制说明

## 通知逻辑

### 边界触发机制

通知采用"边界触发"逻辑，而不是简单的时间间隔：

**盈利通知：**
- ✅ 首次达到盈利阈值（如 3%）→ 发送通知
- ❌ 持续在 3% 以上 → 不重复通知
- ✅ 跌破 2.5% 后再次达到 3% → 再次通知

**亏损通知：**
- ✅ 首次达到亏损阈值（如 -5%）→ 发送通知
- ❌ 持续在 -5% 以下 → 不重复通知
- ✅ 回升到 -4.5% 后再次跌到 -5% → 再次通知

---

## 工作原理

### 状态跟踪

系统为每个持仓维护状态：

```javascript
{
  aboveProfitThreshold: false,  // 是否在盈利阈值以上
  belowLossThreshold: false,    // 是否在亏损阈值以下
  lastNotifyTime: 0             // 最后通知时间
}
```

### 触发条件

#### 盈利通知触发

```
收益率 >= 3%  且  之前不在阈值以上  →  发送通知
收益率 < 2.5%  →  重置状态（可以再次触发）
```

#### 亏损通知触发

```
收益率 <= -5%  且  之前不在阈值以下  →  发送通知
收益率 > -4.5%  →  重置状态（可以再次触发）
```

### 缓冲区（0.5%）

为了避免在阈值边缘反复触发，设置了 0.5% 的缓冲区：

- 盈利阈值 3%，需要跌破 2.5% 才重置
- 亏损阈值 -5%，需要回升到 -4.5% 才重置

---

## 场景示例

### 场景 1：盈利波动

```
时间  收益率  状态          通知
----  ------  -----------  ----
10:00  2.5%   未达阈值      -
10:01  3.0%   达到阈值      ✅ 发送通知
10:02  3.2%   持续在上      -
10:03  3.5%   持续在上      -
10:04  2.8%   仍在阈值内    -
10:05  2.3%   跌破缓冲区    - (重置状态)
10:06  3.1%   再次达到      ✅ 再次通知
```

### 场景 2：亏损波动

```
时间  收益率  状态          通知
----  ------  -----------  ----
10:00  -3.0%  未达阈值      -
10:01  -5.0%  达到阈值      ✅ 发送通知
10:02  -5.5%  持续在下      -
10:03  -6.0%  持续在下      -
10:04  -4.8%  回升缓冲区内  -
10:05  -4.3%  回升缓冲区外  - (重置状态)
10:06  -5.2%  再次跌破      ✅ 再次通知
```

### 场景 3：快速波动

```
时间  收益率  状态          通知
----  ------  -----------  ----
10:00  2.9%   未达阈值      -
10:01  3.1%   达到阈值      ✅ 发送通知
10:02  2.8%   仍在缓冲区    -
10:03  3.0%   仍在阈值上    -
10:04  2.9%   仍在缓冲区    -
10:05  3.2%   仍在阈值上    -
```

**说明：** 在 2.8% - 3.2% 之间波动，只通知一次，避免频繁打扰。

---

## 配置参数

### 阈值配置

```javascript
const notifier = new TelegramNotifier(TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, {
  profitThreshold: 3,                    // 盈利 3% 时通知
  lossThreshold: -5,                     // 亏损 5% 时通知
  timeInterval: 60 * 60 * 1000,          // 1 小时定时通知
  repeatInterval: 5 * 60 * 1000,         // 5 分钟内不重复通知
  enableTimeNotification: true,
  enableProfitNotification: true,
  enableLossNotification: true,
});
```

### 参数说明

| 参数 | 说明 | 作用 |
|------|------|------|
| profitThreshold | 盈利阈值 | 达到此收益率时触发通知 |
| lossThreshold | 亏损阈值 | 达到此亏损率时触发通知 |
| repeatInterval | 重复间隔 | 同一持仓在此时间内不重复通知 |
| 缓冲区（固定 0.5%） | 防抖动 | 避免在阈值边缘反复触发 |

---

## 优势

### 1. 避免频繁通知

**旧逻辑：**
```
3.0% → 通知
3.1% → 5分钟后再通知
3.2% → 5分钟后再通知
...
```

**新逻辑：**
```
3.0% → 通知
3.1% → 不通知（持续在上）
3.2% → 不通知（持续在上）
2.3% → 不通知（跌破但未重新达到）
3.1% → 再次通知（跌破后重新达到）
```

### 2. 关注重要变化

只在以下情况通知：
- ✅ 首次达到目标
- ✅ 跌破后重新达到
- ❌ 持续在目标范围内

### 3. 减少打扰

在阈值附近小幅波动时不会频繁通知。

---

## 实际效果

### 短线交易（波动大）

```
配置：
profitThreshold: 2%
lossThreshold: -3%
repeatInterval: 1 * 60 * 1000  // 1分钟

效果：
- 达到 2% 立即通知
- 在 1.5% - 2.5% 波动不重复通知
- 跌破 1.5% 后再次达到 2% 才通知
```

### 长线持仓（波动小）

```
配置：
profitThreshold: 10%
lossThreshold: -10%
repeatInterval: 30 * 60 * 1000  // 30分钟

效果：
- 达到 10% 立即通知
- 在 9.5% - 15% 波动不重复通知
- 跌破 9.5% 后再次达到 10% 才通知
```

---

## 调试

### 查看状态

在代码中添加调试输出：

```javascript
console.log('阈值状态:', notifier.thresholdState);
```

### 测试通知

```bash
# 运行测试脚本
node test-telegram.js
```

---

## 总结

✅ **智能边界触发** - 只在关键时刻通知  
✅ **避免频繁打扰** - 持续在阈值范围内不重复  
✅ **关注重要变化** - 跌破后重新达到才通知  
✅ **防抖动设计** - 0.5% 缓冲区避免边缘触发  

这样的通知机制更加智能，只在真正需要关注的时候提醒你！🎯
