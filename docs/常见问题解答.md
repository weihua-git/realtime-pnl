# HTX 永续合约监听 - 常见问题解答

## 1. 持仓盈亏计算错误

### 问题
显示的盈亏金额不对，比如持仓 21 张，显示盈亏 -119 USDT，但实际应该是 -1.19 USDT 左右。

### 原因
**HTX 永续合约有不同的合约面值**，不是 1:1 的关系！

| 合约 | 面值 | 说明 |
|------|------|------|
| BTC-USDT | 0.001 BTC/张 | 1 张 = 0.001 个 BTC |
| ETH-USDT | 0.01 ETH/张 | 1 张 = 0.01 个 ETH |
| 其他币种 | 1 USD/张 | 1 张 = 1 美元名义价值 |

### 正确的计算公式

```javascript
// 空仓盈亏
未实现盈亏 = (开仓价 - 当前价) × 持仓量 × 合约面值

// 多仓盈亏
未实现盈亏 = (当前价 - 开仓价) × 持仓量 × 合约面值
```

### 示例计算

**ETH-USDT 空仓：**
- 持仓量：21 张
- 合约面值：0.01 ETH/张
- 开仓价：2273.76 USDT
- 当前价：2280.00 USDT

```
实际持仓 = 21 × 0.01 = 0.21 ETH
价格差 = 2273.76 - 2280.00 = -6.24 USDT
未实现盈亏 = -6.24 × 21 × 0.01 = -1.3104 USDT
```

### 解决方案

使用修复后的 `realtime-pnl.js` 脚本，已经正确处理了合约面值。

---

## 2. WebSocket 自动重连

### 问题
程序运行一段时间后会显示"连接关闭"然后重连。

### 原因

WebSocket 重连是**正常现象**，常见原因：

1. **网络波动** (最常见)
   - 家庭网络不稳定
   - WiFi 信号弱
   - ISP 临时中断

2. **服务器维护**
   - HTX 服务器重启
   - 负载均衡切换
   - 定期维护

3. **心跳超时**
   - 超过 60 秒未收到服务器心跳
   - 网络延迟过高
   - 防火墙阻断

4. **连接空闲**
   - 长时间无数据交换
   - 中间网络设备超时

### 重连机制

程序已经实现了自动重连：

```javascript
// 连接关闭后 5 秒自动重连
setTimeout(() => {
  this.connect();
}, 5000);

// 重连后自动恢复所有订阅
this.resubscribe();
```

### 如何判断是否正常？

**正常重连：**
- ✅ 重连间隔 > 5 分钟
- ✅ 重连后立即恢复
- ✅ 数据继续正常推送

**异常重连：**
- ❌ 频繁重连（< 1 分钟）
- ❌ 重连后无法恢复
- ❌ 持续报错

### 调试重连问题

```bash
# 使用调试模式
node realtime-pnl-debug.js
```

调试模式会显示：
- 每次连接/断开的时间和原因
- 心跳发送和接收情况
- 重连次数统计
- 消息延迟

### 优化建议

1. **改善网络环境**
   ```bash
   # 检查网络延迟
   ping api.hbdm.com
   
   # 检查 DNS 解析
   nslookup api.hbdm.com
   ```

2. **使用有线网络**
   - 比 WiFi 更稳定
   - 延迟更低

3. **检查防火墙**
   - 确保 WebSocket 端口未被阻断
   - 允许 wss:// 协议

4. **使用 VPS**
   - 如果本地网络不稳定
   - 考虑使用云服务器运行

---

## 3. 持仓只推送一次

### 问题
订阅了 `positions` 频道，但只收到一次推送，之后价格变化时没有新推送。

### 原因
这是 **HTX 的正常设计**，不是 bug！

### HTX 推送机制

✅ **会触发推送：**
- 开仓（新建持仓）
- 平仓（减少持仓）
- 加仓（增加持仓）
- 调整保证金
- 强平

❌ **不会触发推送：**
- 价格变化
- 盈亏变化
- 只是查看

### 为什么这样设计？

1. **减少服务器负载**
   - 价格每秒变化多次
   - 如果每次都推送持仓，服务器压力巨大

2. **减少客户端压力**
   - 避免大量无用消息
   - 节省带宽

3. **按需计算**
   - 客户端可以自己订阅行情
   - 根据需要计算实时盈亏

### 解决方案

使用双 WebSocket 方案：

```bash
# 方案 1：使用实时盈亏脚本（推荐）
node realtime-pnl.js

# 方案 2：使用调试模式
node realtime-pnl-debug.js
```

**工作原理：**
1. WebSocket 1（私有）：订阅持仓更新
2. WebSocket 2（公共）：订阅市场行情
3. 本地计算：根据最新价格计算盈亏

---

## 4. 收益率显示异常

### 问题
收益率显示 -268%，但实际应该是 -2.68%。

### 原因
计算公式错误，没有考虑合约面值。

### 正确的计算

```javascript
// 1. 计算未实现盈亏（考虑合约面值）
const contractSize = 0.01; // ETH-USDT
const profitUnreal = (costOpen - lastPrice) * volume * contractSize;

// 2. 计算收益率（基于持仓保证金）
const profitRate = (profitUnreal / positionMargin) * 100;
```

### 示例

**ETH-USDT 空仓：**
- 持仓量：21 张
- 合约面值：0.01 ETH/张
- 开仓价：2273.76
- 当前价：2280.00
- 持仓保证金：47.89 USDT

```javascript
// 计算盈亏
profitUnreal = (2273.76 - 2280.00) × 21 × 0.01
             = -6.24 × 0.21
             = -1.3104 USDT

// 计算收益率
profitRate = (-1.3104 / 47.89) × 100
           = -2.74%
```

---

## 5. 如何验证计算是否正确？

### 方法 1：对比 HTX 平台

1. 登录 HTX 平台
2. 查看持仓详情
3. 对比：
   - 持仓量
   - 开仓均价
   - 未实现盈亏
   - 收益率

### 方法 2：手动计算

```javascript
// 获取持仓信息
持仓量: 21 张
合约面值: 0.01 ETH/张
开仓价: 2273.76 USDT
当前价: 2280.00 USDT
保证金: 47.89 USDT

// 计算
实际持仓 = 21 × 0.01 = 0.21 ETH
价格差 = 2273.76 - 2280.00 = -6.24 USDT
盈亏 = -6.24 × 0.21 = -1.3104 USDT
收益率 = -1.3104 / 47.89 × 100 = -2.74%
```

### 方法 3：使用调试模式

```bash
node realtime-pnl-debug.js
```

调试模式会显示详细的计算过程：
```
持仓: 21 张 × 0.01 = 0.21 ETH
价格: 2280.00 (开仓: 2273.76, 差价: 6.24)
盈亏: -1.3104 USDT | 收益率: -2.74% | 保证金: 47.89 USDT
```

---

## 6. 其他注意事项

### 资金费率
实时盈亏计算**不包含**资金费率，如需精确计算需要额外处理。

### 手续费
开仓手续费已经扣除，平仓手续费需要在实际平仓时计算。

### 滑点
市场价格波动可能导致实际成交价与显示价格有差异。

### 延迟
WebSocket 推送有 100-500ms 延迟，显示的价格可能不是最新的。

---

## 快速命令参考

```bash
# 基础监听（只监听持仓变化）
npm start

# 实时盈亏监控（推荐）
node realtime-pnl.js

# 调试模式（查看详细信息）
node realtime-pnl-debug.js

# 测试持仓推送机制
node test-positions.js
```

---

## 需要帮助？

1. 查看 `README.md` - 完整文档
2. 查看 `持仓监听说明.md` - 技术原理
3. 运行 `node realtime-pnl-debug.js` - 调试问题
4. 查看 HTX API 文档 - https://www.htx.com/zh-cn/opend/

祝交易顺利！🚀
