# 量化交易测试/实盘隔离验证清单

## 验证目的

确保测试模式和实盘模式完全隔离，互不影响。

## 验证步骤

### 1. Redis 键名隔离验证

**测试步骤：**

```bash
# 1. 启动测试模式
# 在 .env 中设置：QUANT_TEST_MODE=true
node realtime-pnl.js

# 2. 等待一段时间后，检查 Redis
redis-cli -n 3
KEYS htx:cache:quant:*

# 预期结果：
# 应该看到：htx:cache:quant:test:BTC-USDT
# 不应该看到：htx:cache:quant:live:BTC-USDT
```

**验证点：**
- ✅ 测试模式只创建 `quant:test:*` 键
- ✅ 不会创建 `quant:live:*` 键

---

### 2. 状态持久化隔离验证

**测试步骤：**

```bash
# 1. 测试模式运行一段时间（产生交易）
# QUANT_TEST_MODE=true
node realtime-pnl.js

# 2. 停止程序，检查 Redis
redis-cli -n 3
GET htx:cache:quant:test:BTC-USDT

# 3. 重启程序，观察日志
node realtime-pnl.js

# 预期日志：
# ✅ 从 Redis 加载测试模式状态
#    Redis Key: quant:test:BTC-USDT
#    余额: XXX USDT
#    持仓数: X
```

**验证点：**
- ✅ 测试模式重启后自动加载状态
- ✅ 余额、持仓、统计数据正确恢复

---

### 3. 实盘模式不保存验证

**测试步骤：**

```bash
# 1. 切换到实盘模式
# 在 .env 中设置：QUANT_TEST_MODE=false
node realtime-pnl.js

# 2. 观察启动日志
# 预期日志：
# 🔴 实盘模式：不从 Redis 加载状态，将从 API 获取真实数据
# 🔴 警告: 实盘模式已启用，将使用真实资金交易！

# 3. 运行一段时间后，检查 Redis
redis-cli -n 3
GET htx:cache:quant:live:BTC-USDT

# 预期结果：(nil) - 没有数据
```

**验证点：**
- ✅ 实盘模式不加载 Redis 状态
- ✅ 实盘模式不保存到 Redis
- ✅ 日志明确标注 "🔴 实盘模式"

---

### 4. 重置功能隔离验证

**测试步骤 A：测试模式重置**

```bash
# 1. 测试模式运行
# QUANT_TEST_MODE=true

# 2. 在 Web 界面点击 "🔄 重新开始" 按钮
# 或调用 API：
curl -X POST http://localhost:3000/api/quant/reset \
  -H "Content-Type: application/json" \
  -d '{"symbol":"BTC-USDT"}'

# 预期响应：
# {
#   "success": true,
#   "message": "测试模式量化交易状态已重置 (BTC-USDT)",
#   "redisKey": "quant:test:BTC-USDT"
# }
```

**测试步骤 B：实盘模式重置（应该被拒绝）**

```bash
# 1. 切换到实盘模式
# QUANT_TEST_MODE=false

# 2. 尝试重置
curl -X POST http://localhost:3000/api/quant/reset \
  -H "Content-Type: application/json" \
  -d '{"symbol":"BTC-USDT"}'

# 预期响应：
# {
#   "error": "实盘模式不允许重置",
#   "message": "为了安全，实盘模式不支持重置功能"
# }
# HTTP 状态码：403
```

**验证点：**
- ✅ 测试模式允许重置
- ✅ 实盘模式拒绝重置（403 错误）
- ✅ 重置后 Redis 键被删除

---

### 5. 模式切换不互相影响验证

**测试步骤：**

```bash
# 1. 测试模式运行，产生一些交易
# QUANT_TEST_MODE=true
node realtime-pnl.js
# 等待产生交易...

# 2. 停止程序，检查测试数据
redis-cli -n 3
GET htx:cache:quant:test:BTC-USDT
# 应该有数据

# 3. 切换到实盘模式
# QUANT_TEST_MODE=false
node realtime-pnl.js

# 4. 停止程序，再次检查测试数据
redis-cli -n 3
GET htx:cache:quant:test:BTC-USDT
# 测试数据应该还在，没有被覆盖

# 5. 切换回测试模式
# QUANT_TEST_MODE=true
node realtime-pnl.js
# 观察日志，应该恢复之前的测试状态
```

**验证点：**
- ✅ 切换到实盘模式不会影响测试数据
- ✅ 切换回测试模式能恢复之前的状态
- ✅ 两种模式的数据完全独立

---

### 6. 持仓验证逻辑隔离验证

**测试步骤：**

```bash
# 1. 测试模式：开仓后立即停止程序
# QUANT_TEST_MODE=true
node realtime-pnl.js
# 等待开仓...
# Ctrl+C 停止

# 2. 等待一段时间（让价格变化）

# 3. 重启程序
node realtime-pnl.js

# 预期日志：
# ⚠️  检测到 1 个测试持仓，将在收到价格后验证是否需要平仓
# 🔍 验证测试持仓状态 (当前价格: XXX)
# 如果触发止盈/止损：
# ⚠️  触发止损/止盈 (离线期间)
```

**验证点：**
- ✅ 测试模式重启后验证持仓
- ✅ 离线期间触发止盈/止损会自动平仓
- ✅ 实盘模式不执行此验证（从 API 获取真实持仓）

---

## 验证结果记录

| 验证项 | 状态 | 备注 |
|--------|------|------|
| Redis 键名隔离 | ⬜ 待验证 | |
| 状态持久化隔离 | ⬜ 待验证 | |
| 实盘模式不保存 | ⬜ 待验证 | |
| 重置功能隔离 | ⬜ 待验证 | |
| 模式切换不互相影响 | ⬜ 待验证 | |
| 持仓验证逻辑隔离 | ⬜ 待验证 | |

## 常见问题排查

### 问题 1：切换模式后数据混乱

**排查步骤：**
```bash
# 1. 检查 .env 配置
cat .env | grep QUANT_TEST_MODE

# 2. 检查 Redis 键名
redis-cli -n 3
KEYS htx:cache:quant:*

# 3. 查看启动日志中的模式标识
# 应该看到：🧪 测试模式 或 🔴 实盘模式
```

### 问题 2：重置功能不工作

**排查步骤：**
```bash
# 1. 确认是测试模式
cat .env | grep QUANT_TEST_MODE
# 应该是：QUANT_TEST_MODE=true

# 2. 检查 Redis 键是否存在
redis-cli -n 3
EXISTS htx:cache:quant:test:BTC-USDT

# 3. 手动删除测试
redis-cli -n 3
DEL htx:cache:quant:test:BTC-USDT
```

### 问题 3：实盘模式意外保存数据

**排查步骤：**
```bash
# 1. 检查实盘键是否存在（不应该存在）
redis-cli -n 3
EXISTS htx:cache:quant:live:BTC-USDT

# 2. 如果存在，说明有 bug，立即停止程序
# 3. 检查代码中的 saveState() 方法
# 应该有：if (!this.config.testMode) return;
```

## 总结

完成以上所有验证后，可以确认：

- ✅ 测试模式和实盘模式完全隔离
- ✅ 数据不会互相覆盖
- ✅ 重置功能只在测试模式有效
- ✅ 实盘模式不使用 Redis 持久化
- ✅ 可以安全地在两种模式之间切换
