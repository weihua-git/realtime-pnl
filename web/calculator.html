<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ­¢ç›ˆæ­¢æŸè®¡ç®—å™¨ - HTX åˆçº¦</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-size: 24px;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-3px);
    }

    .calculator-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .input-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
    }

    .input-group label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .input-group input,
    .input-group select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .input-group .unit {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .quick-tags {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .tag-btn {
      padding: 6px 12px;
      background: #f0f0f0;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tag-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .tag-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .tag-btn.long-active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .tag-btn.short-active {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }

    .calculate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .calculate-btn:hover {
      transform: translateY(-2px);
    }

    .calculate-btn:active {
      transform: translateY(0);
    }

    .results-section {
      display: none;
      margin-top: 30px;
    }

    .results-section.show {
      display: block;
    }

    .result-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .result-card h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .result-row:last-child {
      border-bottom: none;
    }

    .result-label {
      font-size: 14px;
      color: #666;
    }

    .result-value {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .result-value.profit {
      color: #10b981;
    }

    .result-value.loss {
      color: #ef4444;
    }

    .price-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }

    .price-table th,
    .price-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      white-space: nowrap;
    }

    .price-table th {
      background: #f1f3f5;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
    }

    .price-table tr:hover {
      background: #f8f9fa;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 0 -20px;
      padding: 0 20px;
    }

    @media (max-width: 768px) {
      .input-section {
        grid-template-columns: 1fr;
      }

      .header h1 {
        font-size: 24px;
      }

      .calculator-card {
        padding: 20px 15px;
      }

      .result-card {
        padding: 15px;
      }

      .price-table {
        font-size: 12px;
      }

      .price-table th,
      .price-table td {
        padding: 10px 6px;
      }

      .table-wrapper {
        margin: 0 -15px;
        padding: 0 15px;
      }

      .quick-tags {
        gap: 6px;
      }

      .tag-btn {
        padding: 5px 10px;
        font-size: 12px;
      }
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .info-box h4 {
      font-size: 14px;
      color: #1976d2;
      margin-bottom: 8px;
    }

    .info-box p {
      font-size: 13px;
      color: #555;
      line-height: 1.6;
    }

    /* è¿”å›é¡¶éƒ¨æŒ‰é’® */
    .back-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-to-top.show {
      opacity: 1;
      visibility: visible;
    }

    .back-to-top:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .back-to-top:active {
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .back-to-top {
        bottom: 20px;
        right: 20px;
        width: 45px;
        height: 45px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; gap: 15px;">
        <a href="index.html" class="back-btn" title="è¿”å›ä¸»é¡µ">â†</a>
        <div style="text-align: left;">
          <h1>ğŸ§® æ­¢ç›ˆæ­¢æŸè®¡ç®—å™¨</h1>
          <p>ç«å¸ USDT æœ¬ä½æ°¸ç»­åˆçº¦ä¸“ç”¨</p>
        </div>
      </div>
    </div>

    <div class="calculator-card">
      <div class="input-section">
        <div class="input-group">
          <label>äº¤æ˜“å¯¹</label>
          <select id="symbol">
            <option value="BTC-USDT">BTC-USDT</option>
            <option value="ETH-USDT" selected>ETH-USDT</option>
            <option value="SOL-USDT">SOL-USDT</option>
            <option value="BNB-USDT">BNB-USDT</option>
            <option value="XRP-USDT">XRP-USDT</option>
          </select>
        </div>

        <div class="input-group">
          <label>å®æ—¶ä»·æ ¼</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="number" id="livePrice" readonly style="background: #f0f0f0; cursor: not-allowed;" placeholder="ç­‰å¾…æ•°æ®...">
            <button onclick="useCurrentPrice()" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">ä½¿ç”¨</button>
            <button onclick="debugData()" style="padding: 8px 12px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">ğŸ”</button>
          </div>
          <span class="unit" id="priceStatus">è¿æ¥ä¸­...</span>
        </div>

        <div class="input-group">
          <label>å¼€ä»“æ–¹å‘</label>
          <input type="text" id="direction" value="long" readonly style="display: none;">
          <div class="quick-tags">
            <button class="tag-btn long-active" onclick="setDirection('long')" style="flex: 1; font-weight: 600;">ğŸ“ˆ åšå¤š (ä¹°å…¥å¼€å¤š)</button>
            <button class="tag-btn" onclick="setDirection('short')" style="flex: 1; font-weight: 600;">ğŸ“‰ åšç©º (å–å‡ºå¼€ç©º)</button>
          </div>
        </div>

        <div class="input-group">
          <label>å¼€ä»“ä»·æ ¼</label>
          <input type="number" id="entryPrice" placeholder="ä¾‹å¦‚: 1900" step="0.01">
          <span class="unit">USDT</span>
        </div>

        <div class="input-group">
          <label>ä¿è¯é‡‘</label>
          <input type="number" id="margin" placeholder="ä¾‹å¦‚: 50" step="0.01" value="50">
          <div class="quick-tags">
            <button class="tag-btn" onclick="setMargin(10)">10</button>
            <button class="tag-btn active" onclick="setMargin(50)">50</button>
            <button class="tag-btn" onclick="setMargin(100)">100</button>
            <button class="tag-btn" onclick="setMargin(200)">200</button>
            <button class="tag-btn" onclick="setMargin(500)">500</button>
          </div>
          <span class="unit">USDT</span>
        </div>

        <div class="input-group">
          <label>æ æ†å€æ•°</label>
          <input type="number" id="leverage" placeholder="ä¾‹å¦‚: 10" step="1" value="10" readonly style="background: #f8f8f8;">
          <div class="quick-tags">
            <button class="tag-btn" onclick="setLeverage(1)">1x</button>
            <button class="tag-btn" onclick="setLeverage(3)">3x</button>
            <button class="tag-btn" onclick="setLeverage(5)">5x</button>
            <button class="tag-btn" onclick="setLeverage(8)">8x</button>
            <button class="tag-btn active" onclick="setLeverage(10)">10x</button>
            <button class="tag-btn" onclick="setLeverage(20)">20x</button>
            <button class="tag-btn" onclick="setLeverage(50)">50x</button>
          </div>
          <span class="unit">å€</span>
        </div>

        <div class="input-group">
          <label>æ­¢æŸæ¯”ä¾‹</label>
          <input type="number" id="stopLoss" placeholder="ä¾‹å¦‚: 6" step="0.1" value="6">
          <div class="quick-tags">
            <button class="tag-btn" onclick="setStopLoss(2)">2%</button>
            <button class="tag-btn" onclick="setStopLoss(5)">5%</button>
            <button class="tag-btn active" onclick="setStopLoss(6)">6%</button>
            <button class="tag-btn" onclick="setStopLoss(10)">10%</button>
            <button class="tag-btn" onclick="setStopLoss(15)">15%</button>
            <button class="tag-btn" onclick="setStopLoss(20)">20%</button>
          </div>
          <span class="unit">% (æ”¶ç›Šç‡)</span>
        </div>

        <div class="input-group">
          <label>æ­¢ç›ˆæ¯”ä¾‹</label>
          <input type="number" id="takeProfit" placeholder="ä¾‹å¦‚: 10" step="0.1" value="10">
          <div class="quick-tags">
            <button class="tag-btn" onclick="setTakeProfit(5)">5%</button>
            <button class="tag-btn active" onclick="setTakeProfit(10)">10%</button>
            <button class="tag-btn" onclick="setTakeProfit(15)">15%</button>
            <button class="tag-btn" onclick="setTakeProfit(20)">20%</button>
            <button class="tag-btn" onclick="setTakeProfit(30)">30%</button>
            <button class="tag-btn" onclick="setTakeProfit(50)">50%</button>
          </div>
          <span class="unit">% (æ”¶ç›Šç‡)</span>
        </div>
      </div>

      <button class="calculate-btn" onclick="calculate()" style="display: none;">ğŸ’¡ è®¡ç®—æ­¢ç›ˆæ­¢æŸ</button>

      <div class="results-section show" id="results">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="result-card">
          <h3>ğŸ“Š æŒä»“ä¿¡æ¯</h3>
          <div class="result-row">
            <span class="result-label">å¼€ä»“æ–¹å‘</span>
            <span class="result-value" id="resultDirection"></span>
          </div>
          <div class="result-row">
            <span class="result-label">å¼€ä»“ä»·æ ¼</span>
            <span class="result-value" id="resultEntryPrice"></span>
          </div>
          <div class="result-row">
            <span class="result-label">ä¿è¯é‡‘</span>
            <span class="result-value" id="resultMargin"></span>
          </div>
          <div class="result-row">
            <span class="result-label">æ æ†å€æ•°</span>
            <span class="result-value" id="resultLeverage"></span>
          </div>
          <div class="result-row">
            <span class="result-label">æŒä»“ä»·å€¼</span>
            <span class="result-value" id="resultPositionValue"></span>
          </div>
          <div class="result-row">
            <span class="result-label">å¼€ä»“æ‰‹ç»­è´¹</span>
            <span class="result-value loss" id="resultOpenFee"></span>
          </div>
        </div>

        <!-- æ­¢æŸä¿¡æ¯ -->
        <div class="result-card">
          <h3>ğŸ›‘ æ­¢æŸç‚¹ä½ <span style="color: #ef4444; font-size: 14px;" id="stopLossROI"></span></h3>
          <div class="result-row">
            <span class="result-label">æ­¢æŸä»·æ ¼</span>
            <span class="result-value loss" id="stopLossPrice"></span>
          </div>
          <div class="result-row">
            <span class="result-label">ä»·æ ¼å˜åŒ–</span>
            <span class="result-value" id="stopLossPriceChange"></span>
          </div>
          <div class="result-row">
            <span class="result-label">äºæŸé‡‘é¢</span>
            <span class="result-value loss" id="stopLossAmount"></span>
          </div>
          <div class="result-row">
            <span class="result-label">å‰©ä½™èµ„é‡‘</span>
            <span class="result-value" id="stopLossRemaining"></span>
          </div>
        </div>

        <!-- æ­¢ç›ˆä¿¡æ¯ -->
        <div class="result-card">
          <h3>ğŸ¯ æ­¢ç›ˆç‚¹ä½ <span style="color: #10b981; font-size: 14px;" id="takeProfitROI"></span></h3>
          <div class="result-row">
            <span class="result-label">æ­¢ç›ˆä»·æ ¼</span>
            <span class="result-value profit" id="takeProfitPrice"></span>
          </div>
          <div class="result-row">
            <span class="result-label">ä»·æ ¼å˜åŒ–</span>
            <span class="result-value" id="takeProfitPriceChange"></span>
          </div>
          <div class="result-row">
            <span class="result-label">ç›ˆåˆ©é‡‘é¢</span>
            <span class="result-value profit" id="takeProfitAmount"></span>
          </div>
          <div class="result-row">
            <span class="result-label">æ€»èµ„é‡‘</span>
            <span class="result-value" id="takeProfitTotal"></span>
          </div>
        </div>

        <!-- ä»·æ ¼æ¢¯åº¦è¡¨ -->
        <div class="result-card">
          <h3>ğŸ“ˆ ä»·æ ¼æ¢¯åº¦ç›ˆäºè¡¨</h3>
          <div class="table-wrapper">
            <table class="price-table">
              <thead>
                <tr>
                  <th>ä»·æ ¼å˜åŒ–</th>
                  <th>ç›®æ ‡ä»·æ ¼</th>
                  <th>æ”¶ç›Šç‡</th>
                  <th>ç›ˆäºé‡‘é¢</th>
                  <th>æ€»èµ„é‡‘</th>
                </tr>
              </thead>
              <tbody id="priceTable">
              </tbody>
            </table>
          </div>
        </div>

        <!-- è¯´æ˜ -->
        <div class="info-box">
          <h4>ğŸ’¡ è®¡ç®—è¯´æ˜</h4>
          <p>
            â€¢ æ”¶ç›Šç‡ = ä»·æ ¼å˜åŒ–% Ã— æ æ†å€æ•°<br>
            â€¢ ç›ˆäºé‡‘é¢ = ä¿è¯é‡‘ Ã— æ”¶ç›Šç‡ - æ‰‹ç»­è´¹<br>
            â€¢ æ‰‹ç»­è´¹ = ä¿è¯é‡‘ Ã— 0.05% Ã— 2ï¼ˆå¼€ä»“ + å¹³ä»“ï¼‰<br>
            â€¢ æ­¢æŸ/æ­¢ç›ˆä»·æ ¼æ ¹æ®æ”¶ç›Šç‡åæ¨è®¡ç®—<br>
            â€¢ å®é™…äº¤æ˜“ä¸­å¯èƒ½å­˜åœ¨æ»‘ç‚¹ï¼Œå»ºè®®é¢„ç•™ä¸€å®šç©ºé—´
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
  <button class="back-to-top" id="backToTop" onclick="scrollToTop()">
    â†‘
  </button>

  <script>
    // WebSocket è¿æ¥
    let ws = null;
    let currentSymbol = 'ETH-USDT';
    let latestPrice = 0;
    let lastReceivedData = null; // ä¿å­˜æœ€åæ¥æ”¶çš„æ•°æ®ç”¨äºè°ƒè¯•
    let isFirstPrice = true; // æ ‡è®°æ˜¯å¦ç¬¬ä¸€æ¬¡è·å–ä»·æ ¼

    // å¿«æ·è®¾ç½®å‡½æ•°
    function setDirection(value) {
      document.getElementById('direction').value = value;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      const buttons = document.querySelectorAll('.input-group:nth-child(3) .tag-btn');
      buttons.forEach(btn => {
        btn.classList.remove('long-active', 'short-active');
      });
      if (value === 'long') {
        buttons[0].classList.add('long-active');
      } else {
        buttons[1].classList.add('short-active');
      }
      calculate(); // è‡ªåŠ¨è®¡ç®—
    }

    function setMargin(value) {
      document.getElementById('margin').value = value;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.input-group:nth-child(5) .tag-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent == value) {
          btn.classList.add('active');
        }
      });
      calculate(); // è‡ªåŠ¨è®¡ç®—
    }

    function setLeverage(value) {
      document.getElementById('leverage').value = value;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.input-group:nth-child(6) .tag-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent == value + 'x') {
          btn.classList.add('active');
        }
      });
      calculate(); // è‡ªåŠ¨è®¡ç®—
    }

    function setStopLoss(value) {
      document.getElementById('stopLoss').value = value;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.input-group:nth-child(7) .tag-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent == value + '%') {
          btn.classList.add('active');
        }
      });
      calculate(); // è‡ªåŠ¨è®¡ç®—
    }

    function setTakeProfit(value) {
      document.getElementById('takeProfit').value = value;
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.input-group:nth-child(8) .tag-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent == value + '%') {
          btn.classList.add('active');
        }
      });
      calculate(); // è‡ªåŠ¨è®¡ç®—
    }

    // è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ•°æ®
    function debugData() {
      if (lastReceivedData) {
        console.log('=== æœ€åæ¥æ”¶çš„æ•°æ® ===');
        console.log('å®Œæ•´æ•°æ®:', lastReceivedData);
        if (lastReceivedData.data && lastReceivedData.data.prices) {
          console.log('ä»·æ ¼æ•°æ®:', lastReceivedData.data.prices);
          const priceData = lastReceivedData.data.prices[currentSymbol];
          console.log(`å½“å‰äº¤æ˜“å¯¹ ${currentSymbol}:`, priceData);
          if (priceData && typeof priceData === 'object') {
            console.log(`  ä»·æ ¼: ${priceData.price}`);
            console.log(`  æ—¶é—´: ${new Date(priceData.timestamp).toLocaleString('zh-CN')}`);
          }
        }
        alert(`æ•°æ®å·²æ‰“å°åˆ°æ§åˆ¶å°ï¼ˆF12æŸ¥çœ‹ï¼‰\n\nå½“å‰äº¤æ˜“å¯¹: ${currentSymbol}\nä»·æ ¼: ${latestPrice || 'æ— æ•°æ®'} USDT`);
      } else {
        alert('è¿˜æœªæ¥æ”¶åˆ°ä»»ä½•æ•°æ®');
      }
    }

    // è¿æ¥ WebSocket
    function connectWebSocket() {
      const wsUrl = `ws://${window.location.hostname}:${window.location.port}`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WebSocket è¿æ¥æˆåŠŸ');
        document.getElementById('priceStatus').textContent = 'å·²è¿æ¥';
        document.getElementById('priceStatus').style.color = '#10b981';
      };

      ws.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          lastReceivedData = message; // ä¿å­˜ç”¨äºè°ƒè¯•
          
          // æ›´æ–°å®æ—¶ä»·æ ¼
          if (message.type === 'update' && message.data && message.data.prices) {
            const prices = message.data.prices;
            
            // æŸ¥æ‰¾å½“å‰äº¤æ˜“å¯¹çš„ä»·æ ¼
            if (prices[currentSymbol]) {
              // ä»·æ ¼æ•°æ®ç»“æ„: { "ETH-USDT": { "price": 1922.11, "timestamp": ... } }
              const priceData = prices[currentSymbol];
              const price = typeof priceData === 'object' ? parseFloat(priceData.price) : parseFloat(priceData);
              
              // éªŒè¯ä»·æ ¼æ˜¯å¦æœ‰æ•ˆ
              if (!isNaN(price) && price > 0) {
                latestPrice = price;
                document.getElementById('livePrice').value = latestPrice.toFixed(2);
                document.getElementById('priceStatus').textContent = 'å®æ—¶æ›´æ–°';
                document.getElementById('priceStatus').style.color = '#10b981';
                console.log(`æ›´æ–°ä»·æ ¼: ${currentSymbol} = ${latestPrice}`);
                
                // ç¬¬ä¸€æ¬¡è·å–åˆ°ä»·æ ¼æ—¶ï¼Œè‡ªåŠ¨å¡«å……åˆ°å¼€ä»“ä»·æ ¼
                if (isFirstPrice && !document.getElementById('entryPrice').value) {
                  document.getElementById('entryPrice').value = latestPrice.toFixed(2);
                  console.log('é¦–æ¬¡è‡ªåŠ¨å¡«å……å¼€ä»“ä»·æ ¼');
                  isFirstPrice = false;
                }
              } else {
                console.warn(`æ— æ•ˆçš„ä»·æ ¼æ•°æ®:`, priceData);
              }
            } else {
              // å½“å‰äº¤æ˜“å¯¹æ²¡æœ‰ä»·æ ¼æ•°æ®
              console.log(`ç­‰å¾… ${currentSymbol} ä»·æ ¼æ•°æ®...`);
            }
          }
        } catch (error) {
          console.error('è§£ææ•°æ®å¤±è´¥:', error);
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket é”™è¯¯:', error);
        document.getElementById('priceStatus').textContent = 'è¿æ¥å¤±è´¥';
        document.getElementById('priceStatus').style.color = '#ef4444';
      };

      ws.onclose = () => {
        console.log('WebSocket è¿æ¥å…³é—­ï¼Œ5ç§’åé‡è¿...');
        document.getElementById('priceStatus').textContent = 'å·²æ–­å¼€';
        document.getElementById('priceStatus').style.color = '#f59e0b';
        setTimeout(connectWebSocket, 5000);
      };
    }

    // åˆ‡æ¢äº¤æ˜“å¯¹
    document.getElementById('symbol').addEventListener('change', (e) => {
      currentSymbol = e.target.value;
      latestPrice = 0;
      isFirstPrice = true; // é‡ç½®é¦–æ¬¡æ ‡è®°
      document.getElementById('livePrice').value = '';
      document.getElementById('entryPrice').value = ''; // æ¸…ç©ºå¼€ä»“ä»·æ ¼
      document.getElementById('priceStatus').textContent = 'ç­‰å¾…æ•°æ®...';
    });

    // ä½¿ç”¨å½“å‰ä»·æ ¼
    function useCurrentPrice() {
      if (latestPrice > 0) {
        document.getElementById('entryPrice').value = latestPrice.toFixed(2);
        calculate(); // è‡ªåŠ¨è®¡ç®—
      } else {
        alert('æš‚æ— å®æ—¶ä»·æ ¼æ•°æ®ï¼Œè¯·ç¨å€™');
      }
    }

    // é¡µé¢åŠ è½½æ—¶è¿æ¥
    window.addEventListener('load', () => {
      connectWebSocket();
      
      // æ·»åŠ è¾“å…¥ç›‘å¬ï¼Œè‡ªåŠ¨è®¡ç®—
      const inputs = ['direction', 'entryPrice', 'margin', 'leverage', 'stopLoss', 'takeProfit'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', calculate);
          element.addEventListener('change', calculate);
        }
      });
      
      // åˆå§‹è®¡ç®—ä¸€æ¬¡
      setTimeout(calculate, 500);
    });

    // è¿”å›é¡¶éƒ¨åŠŸèƒ½
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }

    // ç›‘å¬æ»šåŠ¨ï¼Œæ˜¾ç¤º/éšè—è¿”å›é¡¶éƒ¨æŒ‰é’®
    window.addEventListener('scroll', () => {
      const backToTopBtn = document.getElementById('backToTop');
      if (window.pageYOffset > 300) {
        backToTopBtn.classList.add('show');
      } else {
        backToTopBtn.classList.remove('show');
      }
    });

    function calculate() {
      // è·å–è¾“å…¥å€¼
      const direction = document.getElementById('direction').value;
      const entryPrice = parseFloat(document.getElementById('entryPrice').value);
      const margin = parseFloat(document.getElementById('margin').value);
      const leverage = parseFloat(document.getElementById('leverage').value);
      const stopLossPercent = parseFloat(document.getElementById('stopLoss').value) / 100;
      const takeProfitPercent = parseFloat(document.getElementById('takeProfit').value) / 100;

      // éªŒè¯è¾“å…¥
      if (!entryPrice || !margin || entryPrice <= 0 || margin <= 0) {
        // å¦‚æœæ•°æ®ä¸å®Œæ•´ï¼Œéšè—ç»“æœ
        return;
      }

      // è®¡ç®—æŒä»“ä»·å€¼
      const positionValue = margin * leverage;
      
      // è®¡ç®—æ‰‹ç»­è´¹ï¼ˆå¼€ä»“ + å¹³ä»“ï¼‰
      const feeRate = 0.0005; // 0.05%
      const openFee = margin * feeRate;
      const closeFee = margin * feeRate;
      const totalFee = openFee + closeFee;

      // è®¡ç®—æ­¢æŸä»·æ ¼ï¼ˆæ”¶ç›Šç‡ = ä»·æ ¼å˜åŒ–% Ã— æ æ†ï¼‰
      // ä»·æ ¼å˜åŒ–% = æ”¶ç›Šç‡ / æ æ†
      const stopLossPriceChangePercent = -stopLossPercent / leverage;
      const takeProfitPriceChangePercent = takeProfitPercent / leverage;

      let stopLossPrice, takeProfitPrice;
      if (direction === 'long') {
        stopLossPrice = entryPrice * (1 + stopLossPriceChangePercent);
        takeProfitPrice = entryPrice * (1 + takeProfitPriceChangePercent);
      } else {
        stopLossPrice = entryPrice * (1 - stopLossPriceChangePercent);
        takeProfitPrice = entryPrice * (1 - takeProfitPriceChangePercent);
      }

      // è®¡ç®—æ­¢æŸç›ˆäº
      const stopLossAmount = margin * (-stopLossPercent) - totalFee;
      const stopLossRemaining = margin + stopLossAmount;

      // è®¡ç®—æ­¢ç›ˆç›ˆäº
      const takeProfitAmount = margin * takeProfitPercent - totalFee;
      const takeProfitTotal = margin + takeProfitAmount;

      // æ˜¾ç¤ºç»“æœ
      document.getElementById('resultDirection').textContent = direction === 'long' ? 'åšå¤š (ä¹°å…¥å¼€å¤š)' : 'åšç©º (å–å‡ºå¼€ç©º)';
      document.getElementById('resultEntryPrice').textContent = entryPrice.toFixed(2) + ' USDT';
      document.getElementById('resultMargin').textContent = margin.toFixed(2) + ' USDT';
      document.getElementById('resultLeverage').textContent = leverage + 'x';
      document.getElementById('resultPositionValue').textContent = positionValue.toFixed(2) + ' USDT';
      document.getElementById('resultOpenFee').textContent = '-' + totalFee.toFixed(4) + ' USDT (å¼€ä»“+å¹³ä»“)';

      // æ­¢æŸä¿¡æ¯
      document.getElementById('stopLossROI').textContent = `(æ”¶ç›Šç‡: -${(stopLossPercent * 100).toFixed(1)}%)`;
      document.getElementById('stopLossPrice').textContent = stopLossPrice.toFixed(2) + ' USDT';
      document.getElementById('stopLossPriceChange').textContent = (stopLossPriceChangePercent * 100).toFixed(2) + '%';
      document.getElementById('stopLossAmount').textContent = stopLossAmount.toFixed(2) + ' USDT';
      document.getElementById('stopLossRemaining').textContent = stopLossRemaining.toFixed(2) + ' USDT';

      // æ­¢ç›ˆä¿¡æ¯
      document.getElementById('takeProfitROI').textContent = `(æ”¶ç›Šç‡: +${(takeProfitPercent * 100).toFixed(1)}%)`;
      document.getElementById('takeProfitPrice').textContent = takeProfitPrice.toFixed(2) + ' USDT';
      document.getElementById('takeProfitPriceChange').textContent = '+' + (takeProfitPriceChangePercent * 100).toFixed(2) + '%';
      document.getElementById('takeProfitAmount').textContent = '+' + takeProfitAmount.toFixed(2) + ' USDT';
      document.getElementById('takeProfitTotal').textContent = takeProfitTotal.toFixed(2) + ' USDT';

      // ç”Ÿæˆä»·æ ¼æ¢¯åº¦è¡¨
      generatePriceTable(direction, entryPrice, margin, leverage, totalFee);
    }

    function generatePriceTable(direction, entryPrice, margin, leverage, totalFee) {
      const tbody = document.getElementById('priceTable');
      tbody.innerHTML = '';

      // ç”Ÿæˆä»·æ ¼æ¢¯åº¦ï¼šåšå¤šæ—¶ä»·æ ¼ä¸Šæ¶¨ä¸ºæ­£ï¼Œåšç©ºæ—¶ä»·æ ¼ä¸‹è·Œä¸ºæ­£
      const priceChanges = direction === 'long' 
        ? [-10, -8, -6, -4, -2, -1, 0, 1, 2, 4, 6, 8, 10]  // åšå¤šï¼šä»·æ ¼ä¸Šæ¶¨ç›ˆåˆ©
        : [10, 8, 6, 4, 2, 1, 0, -1, -2, -4, -6, -8, -10]; // åšç©ºï¼šä»·æ ¼ä¸‹è·Œç›ˆåˆ©

      priceChanges.forEach(priceChangePercent => {
        const priceChange = priceChangePercent / 100;
        
        let targetPrice;
        let profitPercent;
        
        if (direction === 'long') {
          // åšå¤šï¼šä»·æ ¼ä¸Šæ¶¨ç›ˆåˆ©
          targetPrice = entryPrice * (1 + priceChange);
          profitPercent = priceChange * leverage;
        } else {
          // åšç©ºï¼šä»·æ ¼ä¸‹è·Œç›ˆåˆ©
          targetPrice = entryPrice * (1 + priceChange);
          profitPercent = -priceChange * leverage;
        }

        const profitAmount = margin * profitPercent - totalFee;
        const totalBalance = margin + profitAmount;

        const row = document.createElement('tr');
        
        // æ ¹æ®æ–¹å‘æ˜¾ç¤ºä»·æ ¼å˜åŒ–æ ‡ç­¾
        let priceChangeLabel;
        if (direction === 'long') {
          priceChangeLabel = priceChangePercent >= 0 ? `+${priceChangePercent}%` : `${priceChangePercent}%`;
        } else {
          priceChangeLabel = priceChangePercent >= 0 ? `+${priceChangePercent}%` : `${priceChangePercent}%`;
        }
        
        row.innerHTML = `
          <td>${priceChangeLabel}</td>
          <td>${targetPrice.toFixed(2)} USDT</td>
          <td style="color: ${profitPercent >= 0 ? '#10b981' : '#ef4444'}">${profitPercent >= 0 ? '+' : ''}${(profitPercent * 100).toFixed(2)}%</td>
          <td style="color: ${profitAmount >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${profitAmount >= 0 ? '+' : ''}${profitAmount.toFixed(2)} USDT</td>
          <td style="font-weight: 600;">${totalBalance.toFixed(2)} USDT</td>
        `;
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
